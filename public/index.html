<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Attendance System</title>
    <!-- Optional: JSZip for ZIP export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --color-primary: #1f96d3;
            --color-primary-dark: #1a7ca8;
            --color-success: #27ae60;
            --color-danger: #e74c3c;
            --color-warning: #f39c12;
            --color-info: #3498db;
            --color-light: #ecf0f1;
            --color-dark: #2c3e50;
            --color-gray: #95a5a6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--color-dark);
        }

        /* --- LOGIN STYLES --- */
        .login-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #1f96d3 0%, #2c3e50 100%);
            z-index: 2000;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h2 {
            color: var(--color-dark);
            font-size: 28px;
            margin-bottom: 10px;
        }

        .login-header p {
            color: var(--color-gray);
        }

        .login-tabs {
            display: flex;
            background: var(--color-light);
            padding: 5px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .login-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 600;
            color: var(--color-gray);
            transition: all 0.3s;
        }

        .login-tab.active {
            background: white;
            color: var(--color-primary);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        /* --- MAIN APP STYLES --- */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: none;
            /* Hidden by default until login */
        }

        .navbar {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 15px 20px;
            margin-bottom: 30px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar h1 {
            color: var(--color-primary);
            font-size: 24px;
        }

        .navbar-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-info {
            text-align: right;
            margin-right: 10px;
        }

        .user-role-badge {
            background: var(--color-light);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            color: var(--color-dark);
            text-transform: uppercase;
        }

        .offline-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(39, 174, 96, 0.1);
            border-radius: 20px;
            font-weight: 600;
            color: var(--color-success);
        }

        .panel {
            display: none;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            padding: 30px;
            animation: fadeIn 0.3s;
        }

        .panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(31, 150, 211, 0.2);
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        .stat-card.success {
            background: linear-gradient(135deg, var(--color-success), #229954);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, var(--color-warning), #d68910);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, var(--color-danger), #c0392b);
        }

        .section-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--color-dark);
            margin-bottom: 20px;
            border-bottom: 3px solid var(--color-primary);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--color-dark);
        }

        .optional-label::after {
            content: " (Optional)";
            color: var(--color-gray);
            font-size: 12px;
            font-weight: normal;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--color-light);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(31, 150, 211, 0.1);
        }

        button,
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-block;
            text-decoration: none;
        }

        .btn-full {
            width: 100%;
            text-align: center;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(31, 150, 211, 0.3);
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-danger {
            background: var(--color-danger);
            color: white;
        }

        .btn-warning {
            background: var(--color-warning);
            color: white;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        .btn-info {
            background: var(--color-info);
            color: white;
        }

        .btn-info:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: var(--color-gray);
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: var(--color-primary);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--color-light);
        }

        tr:hover {
            background: rgba(31, 150, 211, 0.05);
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--color-light);
            overflow-x: auto;
        }

        .tab-btn {
            padding: 12px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--color-gray);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2500;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            overflow-y: auto;
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            animation: modalPop 0.3s ease-out;
        }

        @keyframes modalPop {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--color-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            font-size: 28px;
            font-weight: bold;
            color: var(--color-gray);
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: rgba(39, 174, 96, 0.1);
            border-color: var(--color-success);
            color: #1e5631;
        }

        .alert-info {
            background: rgba(52, 152, 219, 0.1);
            border-color: var(--color-info);
            color: #2c5282;
        }

        .alert-error {
            background: rgba(231, 76, 60, 0.1);
            border-color: var(--color-danger);
            color: #c0392b;
            display: none;
            /* Hidden by default */
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .file-upload-area {
            border: 2px dashed var(--color-primary);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(31, 150, 211, 0.05);
        }

        .file-upload-area:hover {
            background: rgba(31, 150, 211, 0.1);
            border-color: var(--color-primary-dark);
        }

        .import-progress {
            margin-top: 20px;
            padding: 15px;
            background: rgba(31, 150, 211, 0.1);
            border-radius: 6px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: var(--color-light);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-success);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .year-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .year-btn {
            padding: 8px 16px;
            background: var(--color-light);
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .year-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .summary-box {
            background: rgba(31, 150, 211, 0.05);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--color-primary);
            margin-bottom: 20px;
        }

        /* Filter Styles */
        .filter-container {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            margin-bottom: 10px;
        }

        .filter-group:last-child {
            margin-bottom: 0;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-gray);
            margin-bottom: 8px;
            display: block;
        }

        .filter-btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--color-info);
            background: white;
            color: var(--color-info);
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: #eaf6fd;
        }

        .filter-btn.active {
            background: var(--color-info);
            color: white;
        }

        .bulk-action-bar {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            background: #fff3cd;
            padding: 15px;
            border-radius: 6px;
            color: #856404;
        }

        .bulk-control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .selection-prompt {
            background: #d4edda;
            color: #155724;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #c3e6cb;
            font-size: 14px;
        }

        .selection-prompt button {
            background: transparent;
            border: 1px solid #155724;
            color: #155724;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .selection-prompt button:hover {
            background: #155724;
            color: white;
        }

        /* Checkbox styling */
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--color-primary);
        }

        /* Class Assignment Grid */
        .class-assignment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--color-light);
            padding: 10px;
            border-radius: 6px;
            background: #f9f9f9;
        }

        .class-assign-item {
            background: white;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        /* Student Attendance Card */
        #studentGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .student-attendance-card {
            transition: all 0.3s;
        }

        .student-attendance-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .attendance-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            background: #f0f4f8;
            padding: 6px 10px;
            border-radius: 20px;
            border: 1px solid #dce2e8;
        }

        .attendance-toggle:hover {
            background: #e2e8f0;
        }

        .toggle-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--color-dark);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            min-width: 300px;
            border-left: 5px solid var(--color-primary);
        }

        .toast.success {
            border-left-color: var(--color-success);
        }

        .toast.error {
            border-left-color: var(--color-danger);
        }

        .toast.info {
            border-left-color: var(--color-info);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(10px);
            }
        }

        /* Badge Style for assigned classes */
        .assigned-classes-badge {
            display: inline-block;
            background: #eef2f7;
            border: 1px solid #d1d9e6;
            color: #4a5568;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin: 2px;
        }

        /* Profile Modal Styles */
        .profile-section {
            margin-bottom: 20px;
        }

        .profile-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .profile-info-item label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            display: block;
        }

        .profile-info-item div {
            font-weight: 600;
            color: #333;
            font-size: 15px;
        }

        /* Admin Attendance Table Styles */
        #adminAttendanceTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }

        #adminAttendanceTable th {
            background: var(--color-primary);
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #adminAttendanceTable td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--color-light);
        }

        #adminAttendanceTable tr:hover {
            background: rgba(31, 150, 211, 0.05);
        }

        #adminAttendanceTableContainer {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid var(--color-light);
            border-radius: 8px;
            margin-top: 10px;
        }

        /* Status badges in table */
        .status-badge-table {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-present {
            background: #d4edda;
            color: #155724;
        }

        .status-absent {
            background: #f8d7da;
            color: #721c24;
        }

        .status-late {
            background: #fff3cd;
            color: #856404;
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 15px;
            }

            .navbar-right {
                width: 100%;
                justify-content: space-around;
                flex-wrap: wrap;
            }

            table {
                font-size: 12px;
            }

            th,
            td {
                padding: 8px;
            }

            .bulk-action-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .profile-info-grid {
                grid-template-columns: 1fr;
            }

            #adminAttendanceTable th,
            #adminAttendanceTable td {
                padding: 8px;
                font-size: 12px;
            }
        }
    </style>
</head>

<body>

    <!-- LOGIN SCREEN -->
    <div id="loginOverlay" class="login-wrapper">
        <div class="login-card">
            <div class="login-header">
                <h2>üìö Attendance System</h2>
                <p>Please login to continue</p>
            </div>

            <div class="login-tabs">
                <div class="login-tab active" onclick="switchLoginTab('admin')">Admin</div>
                <div class="login-tab" onclick="switchLoginTab('faculty')">Faculty</div>
                <div class="login-tab" onclick="switchLoginTab('student')">Student</div>
            </div>

            <!-- Admin Login Form -->
            <div id="adminLoginForm" class="login-form active">
                <div class="alert alert-error" id="adminLoginError"></div>
                <form onsubmit="handleAdminLogin(event)">
                    <div class="form-group">
                        <label>Admin Password:</label>
                        <input type="password" id="adminPassword" placeholder="Enter password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Login as Admin</button>
                    <p style="margin-top:10px; font-size:12px; color:var(--color-gray); text-align:center;">
                        <!--Default password: admin123-->
                    </p>
                </form>
            </div>

            <!-- Faculty Login Form -->
            <div id="facultyLoginForm" class="login-form">
                <div class="alert alert-error" id="facultyLoginError"></div>
                <form onsubmit="handleFacultyLogin(event)">
                    <div class="form-group">
                        <label>Faculty ID:</label>
                        <input type="text" id="loginFacultyId" placeholder="Enter Faculty ID" required>
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="loginFacultyPassword" placeholder="Enter password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Login as Faculty</button>
                </form>
            </div>

            <!-- Student Login Form -->
            <div id="studentLoginForm" class="login-form">
                <div class="alert alert-error" id="studentLoginError"></div>
                <form onsubmit="handleStudentLogin(event)">
                    <div class="form-group">
                        <label>Registration Number (Roll No):</label>
                        <input type="text" id="loginStudentId" placeholder="Enter Reg No (e.g. 22156148040)" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Login as Student</button>
                </form>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div class="container" id="mainContainer">
        <div class="navbar">
            <h1>üìö Advanced Attendance System</h1>
            <div class="navbar-right">
                <div class="user-info">
                    <div id="loggedInUser" style="font-weight: 600;">Admin User</div>
                    <span id="roleBadge" class="user-role-badge">ADMIN</span>
                </div>
                <div class="offline-indicator">
                    ‚úÖ Online Mode
                </div>
                <button class="btn btn-danger btn-small" onclick="handleLogout()">Logout</button>
            </div>
        </div>

        <!-- ADMIN PANEL -->
        <div id="adminPanel" class="panel">
            <div class="section">
                <h2 class="section-title">üìä Dashboard</h2>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <h3>Total Students</h3>
                        <div class="value" id="totalStudents">0</div>
                    </div>
                    <div class="stat-card success">
                        <h3>Total Faculty</h3>
                        <div class="value" id="totalFaculty">0</div>
                    </div>
                    <div class="stat-card warning">
                        <h3>Total Classes</h3>
                        <div class="value" id="totalClasses">0</div>
                    </div>
                    <div class="stat-card danger">
                        <h3>Active Years</h3>
                        <div class="value" id="activeYears">0</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchAdminTab('users')">Users</button>
                    <button class="tab-btn" onclick="switchAdminTab('faculty')">Faculty</button>
                    <button class="tab-btn" onclick="switchAdminTab('classes')">Classes</button>
                    <button class="tab-btn" onclick="switchAdminTab('years')">Years & Semesters</button>
                    <button class="tab-btn" onclick="switchAdminTab('bulkImport')">Bulk Import</button>
                    <button class="tab-btn" onclick="switchAdminTab('attendanceHistory')">Attendance History</button>
                    <button class="tab-btn" onclick="switchAdminTab('bulkExport')">Bulk Export</button>
                    <button class="tab-btn" onclick="switchAdminTab('settings')">Settings</button>
                </div>

                <!-- Users Tab -->
                <div id="adminUsers" class="tab-content active">
                    <h2 class="section-title">üë• User Management (Students)</h2>

                    <!-- New Filter Dashboard -->
                    <div class="filter-container">
                        <div class="filter-group">
                            <span class="filter-label">üéì Select Academic Year:</span>
                            <div class="filter-btn-group" id="yearFilterGroup">
                                <button class="filter-btn active" onclick="filterStudents('all')">All</button>
                                <button class="filter-btn" onclick="filterStudents(1)">1st Year</button>
                                <button class="filter-btn" onclick="filterStudents(2)">2nd Year</button>
                                <button class="filter-btn" onclick="filterStudents(3)">3st Year</button>
                                <button class="filter-btn" onclick="filterStudents(4)">4th Year</button>
                            </div>
                        </div>

                        <div class="filter-group" style="margin-top: 15px;">
                            <span class="filter-label">üè´ Select Branch:</span>
                            <select id="branchFilterSelect" onchange="filterByBranch(this.value)"
                                style="padding: 8px; border-radius: 20px; border: 1px solid var(--color-info); background: white; color: var(--color-info); font-weight:600; outline:none; min-width: 200px;">
                                <option value="all">All Branches</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Civil">Civil</option>
                                <option value="Mechanical">Mechanical</option>
                                <option value="Electrical">Electrical</option>
                                <option value="ECE">ECE</option>
                                <option value="CSE(Cyber Security)">CSE(Cyber Security)</option>
                                <option value="CSE(Networks)">CSE(Networks)</option>
                            </select>
                        </div>

                        <div class="filter-group" id="semesterFilterGroup"
                            style="display:none; margin-top:15px; border-top:1px solid #ddd; padding-top:10px;">
                            <span class="filter-label">üìÖ Select Semester:</span>
                            <div class="filter-btn-group" id="semesterButtons">
                                <!-- Dynamic buttons -->
                            </div>
                        </div>

                        <!-- Select All Banner -->
                        <div id="selectAllBanner" class="selection-prompt" style="display:none; margin-top: 15px;">
                            <span id="selectAllText">You have selected 4 students.</span>
                            <button onclick="selectAllListed()">Select all <span id="selectAllCount">0</span> listed
                                students</button>
                        </div>

                        <div id="bulkActionContainer" class="bulk-action-bar" style="display:none;">
                            <div class="bulk-control-group">
                                <strong>üöÄ Increment:</strong>
                                <button class="btn btn-warning" onclick="promoteFilteredStudents()">
                                    +1 Sem <span class="action-target-text">All Listed</span>
                                </button>
                            </div>

                            <div style="width: 1px; height: 30px; background: #ddd; margin: 0 10px;"></div>

                            <div class="bulk-control-group">
                                <strong>üìÖ Set Exact Sem:</strong>
                                <select id="bulkSemSelect"
                                    style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                                    <option value="1">Sem 1</option>
                                    <option value="2">Sem 2</option>
                                    <option value="3">Sem 3</option>
                                    <option value="4">Sem 4</option>
                                    <option value="5">Sem 5</option>
                                    <option value="6">Sem 6</option>
                                    <option value="7">Sem 7</option>
                                    <option value="8">Sem 8</option>
                                </select>
                                <button class="btn btn-info" onclick="setBulkSemester()">Apply to <span
                                        class="action-target-text">All Listed</span></button>
                            </div>

                            <div style="width: 1px; height: 30px; background: #ddd; margin: 0 10px;"></div>

                            <div class="bulk-control-group">
                                <strong>üóëÔ∏è Actions:</strong>
                                <button class="btn btn-danger" onclick="deleteFilteredStudents()">Delete <span
                                        class="action-target-text">Listed</span></button>
                            </div>
                        </div>
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0;">Student List <span id="studentCount"
                                style="font-size:14px; color:gray;">(0)</span></h3>
                        <button class="btn btn-primary" onclick="openModal('addUserModal')">+ Add Student</button>
                    </div>

                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="masterCheckbox" onclick="toggleSelectAll()"></th>
                                <th>Roll No</th>
                                <th>Name</th>
                                <th>Dept</th>
                                <th>Year</th>
                                <th>Sem</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- Faculty Tab -->
                <div id="adminFaculty" class="tab-content">
                    <h2 class="section-title">üë®‚Äçüè´ Faculty Management</h2>

                    <div class="filter-container">
                        <div class="filter-group">
                            <span class="filter-label">üè¢ Filter by Branch:</span>
                            <select id="facultyBranchFilter" onchange="loadFaculty()"
                                style="padding: 8px; border-radius: 20px; border: 1px solid var(--color-info); background: white; color: var(--color-info); font-weight:600; outline:none; min-width: 200px;">
                                <option value="all">All Departments</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Civil">Civil</option>
                                <option value="Mechanical">Mechanical</option>
                                <option value="Electrical">Electrical</option>
                                <option value="ECE">ECE</option>
                                <option value="CSE(Cyber Security)">CSE(Cyber Security)</option>
                                <option value="CSE(Networks)">CSE(Networks)</option>
                                <option value="Applied Science">Applied Science</option>
                            </select>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="openModal('addFacultyModal')">+ Add Faculty</button>
                    </div>

                    <table id="facultyTable">
                        <thead>
                            <tr>
                                <th>Faculty ID</th>
                                <th>Name</th>
                                <th>Assigned Classes</th>
                                <th>Department</th>
                                <th>Specialization</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="facultyTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- Classes Tab -->
                <div id="adminClasses" class="tab-content">
                    <h2 class="section-title">üè´ Classes & Subjects</h2>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="openModal('addClassModal')">+ Add Class</button>
                        <button class="btn btn-success" onclick="openBatchClassModal()">üìÇ Batch Class Creator</button>
                    </div>

                    <!-- Class Filters -->
                    <div class="filter-container">
                        <div class="filter-group">
                            <span class="filter-label">üéì Filter by Year:</span>
                            <div class="filter-btn-group" id="classYearFilterGroup">
                                <button class="filter-btn active" onclick="filterClasses('all')">All</button>
                                <button class="filter-btn" onclick="filterClasses(1)">1st Year</button>
                                <button class="filter-btn" onclick="filterClasses(2)">2nd Year</button>
                                <button class="filter-btn" onclick="filterClasses(3)">3rd Year</button>
                                <button class="tab-btn" onclick="filterClasses(4)">4th Year</button>
                            </div>
                        </div>

                        <div class="filter-group" id="classSemesterFilterGroup"
                            style="display:none; margin-top:15px; border-top:1px solid #ddd; padding-top:10px;">
                            <span class="filter-label">üìÖ Filter by Semester:</span>
                            <div class="filter-btn-group" id="classSemesterButtons">
                                <!-- Dynamic buttons -->
                            </div>
                        </div>
                    </div>

                    <table id="classesTable">
                        <thead>
                            <tr>
                                <th>Class Code</th>
                                <th>Course Name</th>
                                <th>Department</th>
                                <th>Semester</th>
                                <th>Faculty</th>
                                <th>Year</th>
                                <th>Credits</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="classesTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- Years & Semesters Tab -->
                <div id="adminYears" class="tab-content">
                    <h2 class="section-title">üìÖ Years & Semesters</h2>
                    <button class="btn btn-primary" onclick="openModal('addYearModal')">+ Add Academic Year</button>

                    <div id="yearsContainer"></div>

                    <h3 style="margin-top: 30px; margin-bottom: 20px;">Add Custom Semester</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Year:</label>
                            <input type="number" id="customYearInput" placeholder="e.g., 2024">
                        </div>
                        <div class="form-group">
                            <label>Semester Number:</label>
                            <input type="number" id="customSemesterInput" placeholder="e.g., 1-8" min="1" max="8">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-success" onclick="addCustomSemester()">Add Semester</button>
                        </div>
                    </div>
                </div>

                <!-- Bulk Import Tab -->
                <div id="adminBulkImport" class="tab-content">
                    <h2 class="section-title">üì§ Bulk Import</h2>

                    <div class="alert alert-info">
                        ‚ÑπÔ∏è Import multiple records at once from CSV files. Download templates below and fill with your
                        data.
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px;">üì• Download Templates</h3>
                        <button class="btn btn-secondary" onclick="downloadTemplate('students')">üì• Students
                            Template</button>
                        <button class="btn btn-secondary" onclick="downloadTemplate('faculty')">üì• Faculty
                            Template</button>
                        <button class="btn btn-secondary" onclick="downloadTemplate('classes')">üì• Classes
                            Template</button>
                    </div>

                    <!-- Students Import -->
                    <h3 style="margin-bottom: 15px;">üìö Import Students (CSV)</h3>
                    <div class="file-upload-area" id="studentUploadArea"
                        onclick="document.getElementById('studentFile').click()">
                        <div style="font-size: 40px;">üìÑ</div>
                        <p><strong>Click to upload or drag & drop</strong></p>
                        <p style="color: var(--color-gray); font-size: 12px;">CSV file only</p>
                        <input type="file" id="studentFile" accept=".csv" style="display:none;"
                            onchange="handleStudentUpload(event)">
                    </div>
                    <div class="import-progress" id="studentProgress">
                        <div>Importing students...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="studentProgressBar" style="width: 0%">0%</div>
                        </div>
                    </div>

                    <!-- Faculty Import -->
                    <h3 style="margin-top: 30px; margin-bottom: 15px;">üë• Import Faculty (CSV)</h3>
                    <div class="file-upload-area" id="facultyUploadArea"
                        onclick="document.getElementById('facultyFile').click()">
                        <div style="font-size: 40px;">üìÑ</div>
                        <p><strong>Click to upload or drag & drop</strong></p>
                        <p style="color: var(--color-gray); font-size: 12px;">CSV file only</p>
                        <input type="file" id="facultyFile" accept=".csv" style="display:none;"
                            onchange="handleFacultyUpload(event)">
                    </div>
                    <div class="import-progress" id="facultyProgress">
                        <div>Importing faculty...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="facultyProgressBar" style="width: 0%">0%</div>
                        </div>
                    </div>

                    <!-- Classes Import -->
                    <h3 style="margin-top: 30px; margin-bottom: 15px;">üè´ Import Classes (CSV)</h3>
                    <div class="file-upload-area" id="classesUploadArea"
                        onclick="document.getElementById('classesFile').click()">
                        <div style="font-size: 40px;">üìÑ</div>
                        <p><strong>Click to upload or drag & drop</strong></p>
                        <p style="color: var(--color-gray); font-size: 12px;">CSV file only</p>
                        <input type="file" id="classesFile" accept=".csv" style="display:none;"
                            onchange="handleClassesUpload(event)">
                    </div>
                    <div class="import-progress" id="classesProgress">
                        <div>Importing classes...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="classesProgressBar" style="width: 0%">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Attendance History Tab -->
                <div id="adminAttendanceHistory" class="tab-content">
                    <h2 class="section-title">üìä Attendance History Reports</h2>

                    <div class="filter-container" style="margin-bottom: 30px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Select Year:</label>
                                <select id="adminYearFilter" onchange="loadAdminAttendanceHistory()">
                                    <option value="all">All Years</option>
                                    <option value="1">1st Year</option>
                                    <option value="2">2nd Year</option>
                                    <option value="3">3rd Year</option>
                                    <option value="4">4th Year</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Select Branch:</label>
                                <select id="adminBranchFilter" onchange="loadAdminAttendanceHistory()">
                                    <option value="all">All Branches</option>
                                    <option value="Computer Science">Computer Science</option>
                                    <option value="Civil">Civil</option>
                                    <option value="Mechanical">Mechanical</option>
                                    <option value="Electrical">Electrical</option>
                                    <option value="ECE">ECE</option>
                                    <option value="CSE(Cyber Security)">CSE(Cyber Security)</option>
                                    <option value="CSE(Networks)">CSE(Networks)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Date Range:</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="date" id="adminDateFrom" onchange="loadAdminAttendanceHistory()">
                                    <span>to</span>
                                    <input type="date" id="adminDateTo" onchange="loadAdminAttendanceHistory()">
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Sort By:</label>
                                <select id="adminSortBy" onchange="loadAdminAttendanceHistory()">
                                    <option value="date_desc">Date (Newest First)</option>
                                    <option value="date_asc">Date (Oldest First)</option>
                                    <option value="student_asc">Student Name (A-Z)</option>
                                    <option value="student_desc">Student Name (Z-A)</option>
                                    <option value="percentage_asc">Percentage (Low to High)</option>
                                    <option value="percentage_desc">Percentage (High to Low)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Status Filter:</label>
                                <select id="adminStatusFilter" onchange="loadAdminAttendanceHistory()">
                                    <option value="all">All Status</option>
                                    <option value="present">Present Only</option>
                                    <option value="absent">Absent Only</option>
                                    <option value="late">Late Only</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button class="btn btn-info" onclick="loadAdminAttendanceHistory()">üîÑ Refresh</button>
                                <button class="btn btn-secondary" onclick="clearAdminFilters()">üßπ Clear
                                    Filters</button>
                            </div>
                        </div>
                    </div>

                    <div
                        style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <h3>Attendance Records <span id="adminRecordCount">(0)</span></h3>
                        <div>
                            <button class="btn btn-success" onclick="exportAdminHistory('csv')">üì• Export CSV</button>
                            <button class="btn btn-danger" onclick="exportAdminHistory('pdf')">üì• Export PDF</button>
                            <button class="btn btn-primary" onclick="exportAdminHistory('excel')">üì• Export
                                Excel</button>
                            <button class="btn btn-warning" onclick="exportAdminHistory('json')">üì• Export JSON</button>
                        </div>
                    </div>

                    <div id="adminAttendanceTableContainer">
                        <table id="adminAttendanceTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Student Roll No</th>
                                    <th>Student Name</th>
                                    <th>Department</th>
                                    <th>Year</th>
                                    <th>Semester</th>
                                    <th>Class</th>
                                    <th>Faculty</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="adminAttendanceBody">
                                <!-- Records will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <div id="adminAttendanceStats"
                        style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h4>üìà Statistics</h4>
                        <div class="dashboard-grid" style="margin-top: 15px;">
                            <div class="stat-card" style="background: linear-gradient(135deg, #27ae60, #229954);">
                                <h3>Total Records</h3>
                                <div class="value" id="statTotalRecords">0</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                                <h3>Present</h3>
                                <div class="value" id="statPresentCount">0</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                                <h3>Absent</h3>
                                <div class="value" id="statAbsentCount">0</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #f39c12, #d68910);">
                                <h3>Late</h3>
                                <div class="value" id="statLateCount">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Export Tab -->
                <div id="adminBulkExport" class="tab-content">
                    <h2 class="section-title">üì§ Bulk Export</h2>

                    <div class="alert alert-info">
                        ‚ÑπÔ∏è Export complete datasets in CSV format. Data is grouped by year where applicable.
                    </div>

                    <div class="dashboard-grid" style="margin-top: 30px;">
                        <!-- Students Export Card -->
                        <div class="stat-card"
                            style="background: linear-gradient(135deg, #1f96d3, #1a7ca8); cursor: pointer;"
                            onclick="exportBulkData('students')">
                            <div style="font-size: 40px; margin-bottom: 10px;">üë•</div>
                            <h3>Export Students</h3>
                            <p style="opacity: 0.9; font-size: 14px; margin-top: 10px;">
                                Year-wise grouping<br>
                                All student details included
                            </p>
                        </div>

                        <!-- Classes Export Card -->
                        <div class="stat-card"
                            style="background: linear-gradient(135deg, #27ae60, #229954); cursor: pointer;"
                            onclick="exportBulkData('classes')">
                            <div style="font-size: 40px; margin-bottom: 10px;">üìö</div>
                            <h3>Export Classes</h3>
                            <p style="opacity: 0.9; font-size: 14px; margin-top: 10px;">
                                Year-wise grouping<br>
                                All class details included
                            </p>
                        </div>

                        <!-- Faculty Export Card -->
                        <div class="stat-card"
                            style="background: linear-gradient(135deg, #f39c12, #d68910); cursor: pointer;"
                            onclick="exportBulkData('faculty')">
                            <div style="font-size: 40px; margin-bottom: 10px;">üë®‚Äçüè´</div>
                            <h3>Export Faculty</h3>
                            <p style="opacity: 0.9; font-size: 14px; margin-top: 10px;">
                                Complete faculty list<br>
                                All details included
                            </p>
                        </div>

                        <!-- All-in-One Export Card -->
                        <div class="stat-card"
                            style="background: linear-gradient(135deg, #9b59b6, #8e44ad); cursor: pointer;"
                            onclick="exportAllInOne()">
                            <div style="font-size: 40px; margin-bottom: 10px;">üì¶</div>
                            <h3>Export All Data</h3>
                            <p style="opacity: 0.9; font-size: 14px; margin-top: 10px;">
                                Students + Classes + Faculty<br>
                                Multiple CSV files
                            </p>
                        </div>
                    </div>

                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h3>üìä Export Statistics</h3>
                        <div style="display: flex; gap: 20px; margin-top: 15px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <h4>Students</h4>
                                <div id="exportStudentCount"
                                    style="font-size: 24px; font-weight: bold; color: #1f96d3;">0</div>
                                <p style="font-size: 12px; color: gray;">Total students available for export</p>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <h4>Faculty</h4>
                                <div id="exportFacultyCount"
                                    style="font-size: 24px; font-weight: bold; color: #27ae60;">0</div>
                                <p style="font-size: 12px; color: gray;">Total faculty available for export</p>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <h4>Classes</h4>
                                <div id="exportClassCount" style="font-size: 24px; font-weight: bold; color: #f39c12;">0
                                </div>
                                <p style="font-size: 12px; color: gray;">Total classes available for export</p>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <h3>‚ÑπÔ∏è Export Information</h3>
                        <ul style="color: var(--color-gray); margin-top: 10px; line-height: 1.6;">
                            <li>All exports are in CSV format (compatible with Excel)</li>
                            <li>Students are grouped by academic year</li>
                            <li>Classes are grouped by academic year</li>
                            <li>Faculty export includes all details including specialization</li>
                            <li>Use "Export All Data" to get everything in one go</li>
                        </ul>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="adminSettings" class="tab-content">
                    <h2 class="section-title">‚öôÔ∏è Settings</h2>
                    <form onsubmit="saveSettings(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>College Name:</label>
                                <input type="text" id="collegeName" value="Engineering College">
                            </div>
                            <div class="form-group">
                                <label>Min Attendance (%):</label>
                                <input type="number" id="minAttendance" value="75" min="0" max="100">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">üíæ Save</button>
                        <button type="button" class="btn btn-secondary" onclick="exportAllData()">üì• Export All
                            Data</button>
                        <button type="button" class="btn btn-danger" onclick="clearAllStudents()"
                            style="margin-left: 10px;">üóëÔ∏è Clear All Students</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- FACULTY PANEL -->
        <div id="facultyPanel" class="panel">
            <div class="section">
                <div class="tabs" style="margin-bottom: 20px;">
                    <button class="tab-btn active" onclick="switchFacultyTab('mark')">Mark Attendance</button>
                    <button class="tab-btn" onclick="switchFacultyTab('history')">Date-wise History</button>
                    <button class="tab-btn" onclick="switchFacultyTab('report')">Report</button>
                </div>

                <!-- Mark Attendance Tab -->
                <div id="facultyMark" class="tab-content active">
                    <h2 class="section-title">‚úÖ Mark Attendance</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Select Class:</label>
                            <select id="facultyClassSelect" onchange="loadClassStudents()">
                                <option value="">-- Select a class --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date:</label>
                            <input type="date" id="attendanceDate">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="openBulkAttendanceModal()">üìÇ Bulk
                                Upload</button>
                            <button class="btn btn-info" onclick="downloadAttendanceReport()">üì• Download Report
                                (CSV)</button>
                        </div>
                    </div>

                    <!-- Add Student/Batch to Session Logic -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-bottom:10px; color:var(--color-gray);">‚ûï Add Extra Students
                            (Electives/Backlogs)</h4>

                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                            <input type="text" id="addStudentToSessionInput" placeholder="Enter Roll No (e.g. 22156...)"
                                style="flex:1;">
                            <button class="btn btn-info" onclick="addStudentToSession()">Add Single Student</button>
                        </div>

                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap:wrap;">
                            <select id="addBatchBranch" style="flex:1; min-width: 200px;">
                                <option value="">-- Select Branch --</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Civil">Civil</option>
                                <option value="Mechanical">Mechanical</option>
                                <option value="Electrical">Electrical</option>
                                <option value="ECE">ECE</option>
                                <option value="CSE(Cyber Security)">CSE(Cyber Security)</option>
                                <option value="CSE(Networks)">CSE(Networks)</option>
                                <option value="Applied Science">Applied Science</option>
                            </select>
                            <select id="addBatchSem" style="width: 150px;">
                                <option value="">-- Sem --</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                            </select>
                            <button class="btn btn-warning" onclick="addBatchToSession()">Add Whole Batch</button>
                        </div>
                    </div>

                    <div id="studentGridContainer" style="display:none;">
                        <div id="studentGrid"></div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-success" onclick="submitAttendance()">‚úîÔ∏è Submit Attendance</button>
                            <button class="btn btn-secondary" onclick="resetAttendance()">üîÑ Reset</button>
                        </div>
                    </div>
                </div>

                <!-- Date-wise History Tab -->
                <div id="facultyHistory" class="tab-content">
                    <h2 class="section-title">üìÖ Attendance History</h2>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <p style="color: gray; margin:0;">Select a date to view or edit attendance for the selected
                            class.</p>
                        <button class="btn btn-success" onclick="downloadHistoryCSV()">üíæ Download History
                            (CSV)</button>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Select Class:</label>
                            <select id="historyClassSelect" onchange="loadAttendanceHistory()">
                                <option value="">-- Select a class --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Filter Date (Optional):</label>
                            <input type="date" id="historyDateFilter" onchange="loadAttendanceHistory()">
                        </div>
                    </div>

                    <div id="historyList" style="margin-top: 20px;"></div>
                </div>

                <!-- Report Tab -->
                <div id="facultyReport" class="tab-content">
                    <h2 class="section-title">üìà Year-wise Attendance Report</h2>
                    <div class="year-filter" id="yearFilter"></div>
                    <table id="yearWiseAttendanceTable">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Classes Held (Records)</th>
                                <th>Total Attended</th>
                                <th>Absence</th>
                                <th>Late</th>
                                <th>Attendance %</th>
                            </tr>
                        </thead>
                        <tbody id="yearWiseAttendanceBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- STUDENT PANEL -->
        <div id="studentPanel" class="panel">
            <div class="section">
                <h2 class="section-title">üë§ Student Profile</h2>
                <div
                    style="background: var(--color-light); padding: 20px; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center;">
                    <div style="flex: 1; min-width: 200px;">
                        <h3 id="studentNameDisplay" style="color: var(--color-primary); margin-bottom: 5px;">Student
                            Name</h3>
                        <p id="studentRollDisplay" style="font-weight: 600; color: var(--color-gray);">Roll No: -</p>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <p><strong>Email:</strong> <span id="studentEmailDisplay">-</span></p>
                        <p><strong>Department:</strong> <span id="studentDeptDisplay">-</span></p>
                        <p><strong>Semester:</strong> <span id="studentSemDisplay">-</span></p>
                        <p><strong>Year:</strong> <span id="studentYearDisplay">-</span></p>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">üìö My Attendance</h2>
                <table id="studentAttendanceTable">
                    <thead>
                        <tr>
                            <th>Course</th>
                            <th>Faculty</th>
                            <th>Total Classes</th>
                            <th>Attended</th>
                            <th>Percentage</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="studentAttendanceBody">
                        <tr>
                            <td colspan="6" style="text-align:center;">No attendance records found yet.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Faculty Profile Modal -->
    <div id="facultyProfileModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                Faculty Profile
                <button class="close-btn" onclick="closeModal('facultyProfileModal')">&times;</button>
            </div>
            <div id="facultyProfileContent"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-info" id="btnEditFacultyClasses">‚úèÔ∏è Edit Profile & Classes</button>
                <button class="btn btn-secondary" onclick="closeModal('facultyProfileModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Add Student
                <button class="close-btn" onclick="closeModal('addUserModal')">&times;</button>
            </div>
            <form onsubmit="addStudent(event)">
                <div class="form-group">
                    <label>Roll No:</label>
                    <input type="text" id="studentRollNo" oninput="autoFillStudentDetails()" required>
                    <small style="color:var(--color-info);">Enter Roll No (e.g. 22156...) to auto-fill details</small>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name:</label>
                        <input type="text" id="studentFirstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name:</label>
                        <input type="text" id="studentLastName" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="studentEmail" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Department:</label>
                        <select id="studentDept" required>
                            <option value="">-- Select --</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="Civil">Civil</option>
                            <option value="Mechanical">Mechanical</option>
                            <option value="Electrical">Electrical</option>
                            <option value="ECE">ECE</option>
                            <option value="CSE(Cyber Security)">CSE(Cyber Security)</option>
                            <option value="CSE(Networks)">CSE(Networks)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Year:</label>
                        <input type="number" id="studentYear" required>
                    </div>
                    <div class="form-group">
                        <label>Semester:</label>
                        <select id="studentSemester" required>
                            <option value="">-- Select --</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">Add Student</button>
            </form>
        </div>
    </div>

    <!-- Add Faculty Modal -->
    <div id="addFacultyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Add Faculty
                <button class="close-btn" onclick="closeModal('addFacultyModal')">&times;</button>
            </div>
            <form onsubmit="addFaculty(event)">
                <div class="form-group">
                    <label>Faculty ID:</label>
                    <input type="text" id="facultyId" required>
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="facultyPassword" placeholder="Set login password" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name:</label>
                        <input type="text" id="facultyFirstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name:</label>
                        <input type="text" id="facultyLastName" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="optional-label">Email</label>
                    <input type="email" id="facultyEmail" placeholder="Optional field">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Department:</label>
                        <select id="facultyDept" required>
                            <option value="">-- Select --</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="Civil">Civil</option>
                            <option value="Mechanical">Mechanical</option>
                            <option value="Electrical">Electrical</option>
                            <option value="ECE">ECE</option>
                            <option value="CSE(Cyber Security)">CSE(Cyber Security)</option>
                            <option value="CSE(Networks)">CSE(Networks)</option>
                            <option value="Applied Science">Applied Science</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="optional-label">Specialization</label>
                        <input type="text" id="facultySpecial" placeholder="Optional field">
                    </div>
                </div>
                <button type="submit" class="btn btn-success">Add Faculty</button>
            </form>
        </div>
    </div>

    <!-- Edit Faculty Modal -->
    <div id="editFacultyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Edit Faculty
                <button class="close-btn" onclick="closeModal('editFacultyModal')">&times;</button>
            </div>
            <form onsubmit="updateFaculty(event)">
                <input type="hidden" id="editFacultyIdKey">
                <div class="form-group">
                    <label>Faculty ID:</label>
                    <input type="text" id="editFacultyId" required>
                </div>
                <div class="form-group">
                    <label>Password (Leave blank to keep current):</label>
                    <input type="password" id="editFacultyPassword" placeholder="Enter new password to change">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name:</label>
                        <input type="text" id="editFacultyFirstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name:</label>
                        <input type="text" id="editFacultyLastName" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="editFacultyEmail">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Department:</label>
                        <select id="editFacultyDept" required>
                            <option value="">-- Select --</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="Civil">Civil</option>
                            <option value="Mechanical">Mechanical</option>
                            <option value="Electrical">Electrical</option>
                            <option value="ECE">ECE</option>
                            <option value="CSE(Cyber Security)">CSE(Cyber Security)</option>
                            <option value="CSE(Networks)">CSE(Networks)</option>
                            <option value="Applied Science">Applied Science</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Specialization:</label>
                        <input type="text" id="editFacultySpecial">
                    </div>
                </div>

                <h4 style="margin-bottom:10px; margin-top:20px; border-bottom:1px solid #ddd; padding-bottom:5px;">
                    Assign Classes</h4>
                <p style="font-size:12px; color:gray; margin-bottom:10px;">Select classes to assign to this faculty
                    member.</p>
                <div class="class-assignment-grid" id="editFacultyClassesList"></div>

                <div style="margin-top:20px;">
                    <button type="submit" class="btn btn-success">Update Faculty</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Class Modal -->
    <div id="addClassModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Add Class
                <button class="close-btn" onclick="closeModal('addClassModal')">&times;</button>
            </div>
            <form onsubmit="addClass(event)">
                <div class="form-group">
                    <label>Class Code:</label>
                    <input type="text" id="classCode" required>
                </div>
                <div class="form-group">
                    <label>Course Name:</label>
                    <input type="text" id="courseName" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Department:</label>
                        <select id="classDept" required>
                            <option value="">-- Select --</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="Civil">Civil</option>
                            <option value="Mechanical">Mechanical</option>
                            <option value="Electrical">Electrical</option>
                            <option value="ECE">ECE</option>
                            <option value="CSE(Cyber Security)">CSE(Cyber Security)</option>
                            <option value="CSE(Networks)">CSE(Networks)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Semester:</label>
                        <input type="number" id="classSemester" required>
                    </div>
                    <div class="form-group">
                        <label>Year:</label>
                        <input type="number" id="classYear" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Faculty:</label>
                        <select id="classFaculty" required></select>
                    </div>
                    <div class="form-group">
                        <label>Credits:</label>
                        <input type="number" id="classCredits" value="3">
                    </div>
                </div>
                <button type="submit" class="btn btn-success">Add Class</button>
            </form>
        </div>
    </div>

    <!-- Edit Class Modal -->
    <div id="editClassModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Edit Class
                <button class="close-btn" onclick="closeModal('editClassModal')">&times;</button>
            </div>
            <form onsubmit="updateClass(event)">
                <input type="hidden" id="editClassIdKey">
                <div class="form-group">
                    <label>Class Code:</label>
                    <input type="text" id="editClassCode" required>
                </div>
                <div class="form-group">
                    <label>Course Name:</label>
                    <input type="text" id="editCourseName" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Department:</label>
                        <select id="editClassDept" required>
                            <option value="">-- Select --</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="Civil">Civil</option>
                            <option value="Mechanical">Mechanical</option>
                            <option value="Electrical">Electrical</option>
                            <option value="ECE">ECE</option>
                            <option value="CSE(Cyber Security)">CSE(Cyber Security)</option>
                            <option value="CSE(Networks)">CSE(Networks)</option>
                            <option value="Applied Science">Applied Science</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Semester:</label>
                        <input type="number" id="editClassSemester" required>
                    </div>
                    <div class="form-group">
                        <label>Year:</label>
                        <input type="number" id="editClassYear" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Faculty:</label>
                        <select id="editClassFaculty" required></select>
                    </div>
                    <div class="form-group">
                        <label>Credits:</label>
                        <input type="number" id="editClassCredits" value="3">
                    </div>
                </div>
                <button type="submit" class="btn btn-success">Update Class</button>
            </form>
        </div>
    </div>

    <!-- Batch Class Creator Modal -->
    <div id="batchClassModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                Batch Class Creator
                <button class="close-btn" onclick="closeModal('batchClassModal')">&times;</button>
            </div>
            <div class="alert alert-info">
                ‚ÑπÔ∏è Paste your class list in the format: <strong>Semester, Subject Name, Subject Code, Faculty
                    Name</strong>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Branch / Department (Applied to all):</label>
                    <select id="batchBranch" required>
                        <option value="Computer Science">Computer Science</option>
                        <option value="Civil">Civil</option>
                        <option value="Mechanical">Mechanical</option>
                        <option value="Electrical">Electrical</option>
                        <option value="ECE">ECE</option>
                        <option value="CSE(Cyber Security)">CSE(Cyber Security)</option>
                        <option value="CSE(Networks)">CSE(Networks)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Year (Applied to all):</label>
                    <input type="number" id="batchYear" value="2024">
                </div>
            </div>

            <div class="form-group">
                <label>Paste Data (Each line is a new subject):</label>
                <textarea id="batchClassInput" rows="6"
                    placeholder="Example:\n1, Mathematics-I, MAT101, Dr. Smith\n1, Physics, PHY101, Prof. Doe"></textarea>
            </div>

            <button class="btn btn-primary" onclick="previewBatchClasses()">üîç Parse & Preview</button>

            <div id="batchPreviewArea" style="display:none; margin-top: 20px;">
                <h3>Preview</h3>
                <table id="batchPreviewTable">
                    <thead>
                        <tr>
                            <th>Sem</th>
                            <th>Subject</th>
                            <th>Code</th>
                            <th>Faculty</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn btn-success" onclick="saveBatchClasses()">üíæ Save All Classes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Attendance Modal -->
    <div id="bulkAttendanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Bulk Upload Attendance
                <button class="close-btn" onclick="closeModal('bulkAttendanceModal')">&times;</button>
            </div>
            <div class="alert alert-info">
                Paste student Roll Numbers for the selected class. <br>
                Format: <strong>RollNo</strong> (Default: Present) or <strong>RollNo, Status (P/A/L)</strong>
            </div>
            <div class="form-group">
                <label>Attendance Data:</label>
                <textarea id="bulkAttendanceInput" rows="10"
                    placeholder="22156148040, P\n22156148041, A\n..."></textarea>
            </div>
            <button class="btn btn-success" onclick="saveBulkAttendance()">üíæ Upload & Save</button>
        </div>
    </div>

    <!-- Add Year Modal -->
    <div id="addYearModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Add Academic Year
                <button class="close-btn" onclick="closeModal('addYearModal')">&times;</button>
            </div>
            <form onsubmit="addAcademicYear(event)">
                <div class="form-group">
                    <label>Year (e.g., 2024):</label>
                    <input type="number" id="academicYear" placeholder="2024" required>
                </div>
                <div class="form-group">
                    <label>Start Date:</label>
                    <input type="date" id="yearStartDate" required>
                </div>
                <div class="form-group">
                    <label>End Date:</label>
                    <input type="date" id="yearEndDate" required>
                </div>
                <button type="submit" class="btn btn-success">Add Year</button>
            </form>
        </div>
    </div>

    <!-- Edit Attendance Modal -->
    <div id="editAttendanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Edit Attendance Record
                <button class="close-btn" onclick="closeModal('editAttendanceModal')">&times;</button>
            </div>
            <form onsubmit="saveEditedAttendance(event)">
                <input type="hidden" id="editAttendanceId">
                <input type="hidden" id="editAttendanceStudentId">

                <div class="profile-info-grid">
                    <div class="profile-info-item">
                        <label>Student</label>
                        <div id="editStudentInfo">-</div>
                    </div>
                    <div class="profile-info-item">
                        <label>Class</label>
                        <div id="editClassInfo">-</div>
                    </div>
                    <div class="profile-info-item">
                        <label>Date</label>
                        <div id="editDateInfo">-</div>
                    </div>
                    <div class="profile-info-item">
                        <label>Faculty</label>
                        <div id="editFacultyInfo">-</div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>Attendance Status:</label>
                    <div style="display: flex; gap: 15px; margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="attendanceStatus" value="present" checked>
                            <span
                                style="padding: 8px 15px; background: #d4edda; color: #155724; border-radius: 4px;">Present</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="attendanceStatus" value="absent">
                            <span
                                style="padding: 8px 15px; background: #f8d7da; color: #721c24; border-radius: 4px;">Absent</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="attendanceStatus" value="late">
                            <span
                                style="padding: 8px 15px; background: #fff3cd; color: #856404; border-radius: 4px;">Late</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="optional-label">Notes (Optional)</label>
                    <textarea id="editAttendanceNotes" rows="3"
                        placeholder="Add any notes about this attendance record..."></textarea>
                </div>

                <div style="margin-top: 20px; display: flex; justify-content: space-between;">
                    <button type="button" class="btn btn-danger" onclick="deleteAttendanceRecord()">üóëÔ∏è Delete
                        Record</button>
                    <div>
                        <button type="button" class="btn btn-secondary"
                            onclick="closeModal('editAttendanceModal')">Cancel</button>
                        <button type="submit" class="btn btn-success">üíæ Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                Confirm Action
                <button class="close-btn" onclick="closeModal('confirmationModal')">&times;</button>
            </div>
            <p id="confirmationMessage" style="margin-bottom: 25px; font-size: 16px;">Are you sure?</p>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeModal('confirmationModal')">Cancel</button>
                <button class="btn btn-danger" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>

        let db;

        const DB_NAME = 'AdvancedAttendanceDB';
        const DB_VERSION = 2;
        const ADMIN_PASSWORD = 'admin123';
        let currentUser = null;
        // vercel
        // ===================== VERCEL KV SYNC =====================
        // Replace this whole section at the beginning of your cloud sync code:
        const VERCEL_URL = "https://attendance-system-kv.vercel.app";
        let deviceId = localStorage.getItem('attendance_device_id') || generateDeviceId();

        function generateDeviceId() {
            const id = 'device_' + Date.now() + '_' + Math.random().toString(36).slice(2, 10);
            localStorage.setItem('attendance_device_id', id);
            return id;
}

        // Save data to Vercel KV
        async function saveToKV() {
            if (syncInProgress) {
                showToast('üîÑ Sync in progress...', 'info');
                return;
            }

            syncInProgress = true;
            showToast('üíæ Saving to cloud...', 'info');

            try {
                // Get all local data
                const [students, faculty, classes, attendance, years, settings] = await Promise.all([
                    getAll('students'),
                    getAll('faculty'),
                    getAll('classes'),
                    getAll('attendance'),
                    getAll('years'),
                    getAll('settings')
                ]);

                const collections = {
                    students, faculty, classes, attendance, years, settings
                };

                // Send to Vercel KV
                const response = await fetch(`${VERCEL_URL}/api/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deviceId, collections })
                });

                const result = await response.json();

                if (result.success) {
                    showToast(`‚úÖ ${result.message}`, 'success');
                    updateSyncStatus(true, result.syncId);
                } else {
                    throw new Error(result.error || 'Sync failed');
                }

            } catch (error) {
                console.error('Save error:', error);
                showToast(`‚ùå Save failed: ${error.message}`, 'error');
                updateSyncStatus(false);
            } finally {
                syncInProgress = false;
            }
        }

        // Load data from Vercel KV
        async function loadFromKV() {
            showToast('üì• Loading from cloud...', 'info');

            try {
                const response = await fetch(`${VERCEL_URL}/api/data`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Load failed');
                }

                const { data, stats } = result;

                // Clear local stores
                const stores = ['students', 'faculty', 'classes', 'attendance', 'years', 'settings'];
                for (const store of stores) {
                    await clearStore(store);
                }

                // Restore data
                let total = 0;
                for (const [collection, items] of Object.entries(data)) {
                    for (const item of items) {
                        await addRecord(collection, item);
                        total++;
                    }
                }

                // Update UI
                loadStudents();
                loadFaculty();
                loadClasses();
                loadYears();
                updateDashboard();

                showToast(`‚úÖ Loaded ${total} records (${stats.totalDevices} devices)`, 'success');

            } catch (error) {
                console.error('Load error:', error);
                showToast(`‚ùå Load failed: ${error.message}`, 'error');
            }
        }

        // Check KV status
        async function checkKVStatus() {
            try {
                const response = await fetch(`${VERCEL_URL}/api/status`);
                const status = await response.json();
                return status.online;
            } catch (error) {
                return false;
            }
        }
        async function testSyncEndpoint() {
            console.log('Testing sync endpoint...');

            try {
                const testData = {
                    deviceId: 'test_device',
                    collections: {
                        students: [{ id: 1, name: 'Test Student' }],
                        faculty: [],
                        classes: [],
                        attendance: [],
                        years: [],
                        settings: []
                    }
                };

                const response = await fetch('/api/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                const text = await response.text();
                console.log('Response text:', text);

                try {
                    const json = JSON.parse(text);
                    console.log('Parsed JSON:', json);
                } catch (e) {
                    console.log('Not valid JSON:', e.message);
                }

            } catch (error) {
                console.error('Test failed:', error);
            }
        }

        // Call it to test
        testSyncEndpoint();
        // Update UI status
        function updateSyncStatus(connected, syncId = null) {
            const indicator = document.querySelector('.offline-indicator');
            if (!indicator) return;

            if (connected) {
                indicator.innerHTML = '‚úÖ Cloud Sync Active';
                indicator.style.background = 'rgba(39, 174, 96, 0.1)';
                indicator.style.color = 'var(--color-success)';
            } else {
                indicator.innerHTML = '‚ö†Ô∏è Working Offline';
                indicator.style.background = 'rgba(243, 156, 18, 0.1)';
                indicator.style.color = 'var(--color-warning)';
            }
        }

        // Add sync buttons to navbar
        function addKVSyncUI() {
            const navbarRight = document.querySelector('.navbar-right');
            if (!navbarRight || document.getElementById('kvSyncUI')) return;

            const syncDiv = document.createElement('div');
            syncDiv.id = 'kvSyncUI';
            syncDiv.style.display = 'flex';
            syncDiv.style.gap = '10px';
            syncDiv.style.alignItems = 'center';
            syncDiv.style.marginRight = '15px';

            syncDiv.innerHTML = `
        <button onclick="loadFromKV()" class="btn btn-success btn-small"
                style="padding: 6px 12px; font-size: 12px;">
            üì• Load Cloud
        </button>
        <button onclick="saveToKV()" class="btn btn-info btn-small"
                style="padding: 6px 12px; font-size: 12px;">
            üíæ Save Cloud
        </button>
        <div style="font-size: 11px; color: #666; background: #f0f0f0; 
              padding: 2px 6px; border-radius: 3px;">
            ${deviceId.substring(0, 8)}...
        </div>
    `;

            navbarRight.insertBefore(syncDiv, navbarRight.firstChild);
        }

        // Auto-save every 2 minutes
        function startAutoSync() {
            setInterval(async () => {
                if (navigator.onLine && !syncInProgress) {
                    await saveToKV();
                }
            }, 120000); // 2 minutes
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for everything to load
            setTimeout(async () => {
                // Add sync UI
                addKVSyncUI();

                // Check connection
                const isConnected = await checkKVStatus();
                updateSyncStatus(isConnected);

                // Auto-load on first connection
                if (isConnected) {
                    const firstLoad = localStorage.getItem('kv_first_load');
                    if (!firstLoad) {
                        setTimeout(loadFromKV, 2000);
                        localStorage.setItem('kv_first_load', 'done');
                    }
                }

                // Start auto-sync
                startAutoSync();
            }, 1500);
        });
        // Branch Mapping
        const branchMap = {
            '101': 'Civil',
            '102': 'Mechanical',
            '103': 'Electrical',
            '104': 'ECE',
            '152': 'CSE(Cyber Security)',
            '156': 'CSE(Networks)'
        };

        let activeStudentFilter = {
            year: 'all',
            semester: null,
            branch: 'all'
        };

        let activeClassFilter = {
            year: 'all',
            semester: null
        };

        let displayedStudents = [];
        let selectedStudentIds = new Set();

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            let icon = '‚úÖ';
            if (type === 'error') icon = '‚ùå';
            if (type === 'info') icon = '‚ÑπÔ∏è';

            toast.innerHTML = `<div>${icon}</div><div>${message}</div>`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        let pendingAction = null;

        function showConfirm(message, actionCallback) {
            document.getElementById('confirmationMessage').textContent = message;
            pendingAction = actionCallback;
            openModal('confirmationModal');
        }

        document.getElementById('confirmActionBtn').onclick = function () {
            if (pendingAction) pendingAction();
            closeModal('confirmationModal');
            pendingAction = null;
        };

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    const stores = ['students', 'faculty', 'classes', 'attendance', 'settings', 'years'];
                    stores.forEach(store => {
                        if (!db.objectStoreNames.contains(store)) {
                            db.createObjectStore(store, { keyPath: 'id', autoIncrement: true });
                        }
                    });
                };
            });
        }

        function addRecord(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
            });
        }

        function updateRecord(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
            });
        }

        function getAll(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
            });
        }

        function getRecord(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
            });
        }

        function deleteRecord(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve();
            });
        }

        function clearStore(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve();
            });
        }

        function switchLoginTab(role) {
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.login-tab[onclick="switchLoginTab('${role}')"]`).classList.add('active');
            document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
            document.getElementById(role + 'LoginForm').classList.add('active');
            document.querySelectorAll('.alert-error').forEach(e => {
                e.style.display = 'none';
                e.textContent = '';
            });
        }

        async function handleAdminLogin(event) {
            event.preventDefault();
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('adminLoginError');
            if (password === ADMIN_PASSWORD) {
                completeLogin('admin', { name: 'Admin User' });
            } else {
                errorDiv.textContent = '‚ùå Incorrect Admin Password';
                errorDiv.style.display = 'block';
            }
        }

        async function handleFacultyLogin(event) {
            event.preventDefault();
            const id = document.getElementById('loginFacultyId').value;
            const password = document.getElementById('loginFacultyPassword').value;
            const errorDiv = document.getElementById('facultyLoginError');
            const allFaculty = await getAll('faculty');
            const facultyMember = allFaculty.find(f => f.facultyId === id);
            if (facultyMember) {
                const storedPassword = facultyMember.password || 'password123';
                if (password === storedPassword) {
                    completeLogin('faculty', facultyMember);
                } else {
                    errorDiv.textContent = '‚ùå Incorrect Password';
                    errorDiv.style.display = 'block';
                }
            } else {
                errorDiv.textContent = '‚ùå Faculty ID not found';
                errorDiv.style.display = 'block';
            }
        }

        async function handleStudentLogin(event) {
            event.preventDefault();
            const rollNo = document.getElementById('loginStudentId').value;
            const errorDiv = document.getElementById('studentLoginError');
            const allStudents = await getAll('students');
            const student = allStudents.find(s => s.rollNo === rollNo);
            if (student) {
                completeLogin('student', student);
            } else {
                errorDiv.textContent = '‚ùå Student Roll No not found';
                errorDiv.style.display = 'block';
            }
        }

        function completeLogin(role, userData) {
            currentUser = { role, ...userData };
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';

            const name = role === 'admin' ? 'Admin User' : `${userData.firstName} ${userData.lastName}`;
            document.getElementById('loggedInUser').textContent = name;
            document.getElementById('roleBadge').textContent = role.toUpperCase();

            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(role + 'Panel').classList.add('active');

            if (role === 'faculty') {
                populateFacultyClassDropdown();
            } else if (role === 'student') {
                populateStudentDashboard(userData);
            } else if (role === 'admin') {
                populateFacultyClassDropdown(); // Admins also need class dropdowns
                loadAdminAttendanceHistory(); // Load admin history on login
            }

            document.getElementById('adminPassword').value = '';
            document.getElementById('loginFacultyId').value = '';
            document.getElementById('loginFacultyPassword').value = '';
            document.getElementById('loginStudentId').value = '';
        }

        async function populateFacultyClassDropdown() {
            const classes = await getAll('classes');
            const facultySelect = document.getElementById('facultyClassSelect');
            const historySelect = document.getElementById('historyClassSelect');

            facultySelect.innerHTML = '<option value="">-- Select a class --</option>';
            historySelect.innerHTML = '<option value="">-- Select a class --</option>';

            const facultyName = `${currentUser.firstName} ${currentUser.lastName}`;
            let myClasses;

            if (currentUser.role === 'admin') {
                myClasses = classes; // Admins can see all classes
            } else {
                myClasses = classes.filter(c => c.faculty === facultyName);
            }

            myClasses.forEach(cls => {
                const opt1 = document.createElement('option');
                opt1.value = cls.id;
                opt1.textContent = `${cls.code}: ${cls.name} (Sem ${cls.semester}, ${cls.department})`;
                facultySelect.appendChild(opt1.cloneNode(true));
                historySelect.appendChild(opt1);
            });
        }

        async function populateStudentDashboard(student) {
            document.getElementById('studentNameDisplay').textContent = `${student.firstName} ${student.lastName}`;
            document.getElementById('studentRollDisplay').textContent = `Roll No: ${student.rollNo}`;
            document.getElementById('studentEmailDisplay').textContent = student.email || 'N/A';
            document.getElementById('studentDeptDisplay').textContent = student.department;
            document.getElementById('studentSemDisplay').textContent = student.semester;
            document.getElementById('studentYearDisplay').textContent = student.year;

            await loadStudentStats(student.id);
        }

        async function loadStudentStats(studentId) {
            const attendance = await getAll('attendance');
            const classes = await getAll('classes');

            // Filter attendance for this student
            const studentAttendance = attendance.filter(r => r.studentId === studentId);

            // Group by classId
            const attendanceByClass = {};
            studentAttendance.forEach(r => {
                if (!attendanceByClass[r.classId]) {
                    attendanceByClass[r.classId] = { total: 0, present: 0, absent: 0, late: 0 };
                }
                attendanceByClass[r.classId].total++;
                if (r.status === 'present') attendanceByClass[r.classId].present++;
                if (r.status === 'absent') attendanceByClass[r.classId].absent++;
                if (r.status === 'late') attendanceByClass[r.classId].late++;
            });

            const tbody = document.getElementById('studentAttendanceBody');
            tbody.innerHTML = '';

            if (Object.keys(attendanceByClass).length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No attendance records found yet.</td></tr>';
                return;
            }

            for (const classId in attendanceByClass) {
                const cls = classes.find(c => c.id === parseInt(classId));
                if (!cls) continue;

                const stats = attendanceByClass[classId];
                const percentage = stats.total > 0 ? Math.round((stats.present / stats.total) * 100) : 0;
                const status = percentage >= 75 ? '<span class="status-badge" style="background:#d4edda; color:#155724;">Good</span>' : '<span class="status-badge" style="background:#f8d7da; color:#721c24;">Low</span>';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${cls.name} (${cls.code})</td>
                    <td>${cls.faculty}</td>
                    <td>${stats.total}</td>
                    <td>${stats.present}</td>
                    <td>${percentage}%</td>
                    <td>${status}</td>
                 `;
                tbody.appendChild(row);
            }
        }

        function handleLogout() {
            showConfirm('Are you sure you want to logout?', function () {
                currentUser = null;
                document.getElementById('facultyClassSelect').innerHTML = '<option value="">-- Select a class --</option>';
                document.getElementById('studentGrid').innerHTML = '';
                document.getElementById('studentGridContainer').style.display = 'none';

                document.getElementById('loginOverlay').style.display = 'flex';
                document.getElementById('mainContainer').style.display = 'none';
                showToast('Logged out successfully', 'info');
            });
        }

        function switchFacultyTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('facultyMark').style.display = 'none';
            document.getElementById('facultyHistory').style.display = 'none';
            document.getElementById('facultyReport').style.display = 'none';

            if (tab === 'mark') document.getElementById('facultyMark').style.display = 'block';
            else if (tab === 'history') {
                document.getElementById('facultyHistory').style.display = 'block';
                loadAttendanceHistory();
            }
            else if (tab === 'report') {
                document.getElementById('facultyReport').style.display = 'block';
                generateYearlyReport();
            }
        }

        async function loadAttendanceHistory() {
            const classId = parseInt(document.getElementById('historyClassSelect').value);
            const dateFilter = document.getElementById('historyDateFilter').value;
            const container = document.getElementById('historyList');

            if (!classId) {
                container.innerHTML = '<p style="text-align:center; color:gray;">Please select a class first.</p>';
                return;
            }

            const allAttendance = await getAll('attendance');
            const allStudents = await getAll('students');
            const allClasses = await getAll('classes');

            const classInfo = allClasses.find(c => c.id === classId);
            if (!classInfo) return;

            let classRecords = allAttendance.filter(r => r.classId === classId);

            if (dateFilter) {
                classRecords = classRecords.filter(r => r.date === dateFilter);
            }

            const dates = [...new Set(classRecords.map(r => r.date))].sort().reverse();

            container.innerHTML = '';
            if (dates.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:gray;">No attendance records found.</p>';
                return;
            }

            dates.forEach(date => {
                const recordsForDate = classRecords.filter(r => r.date === date);
                const total = recordsForDate.length;
                const present = recordsForDate.filter(r => r.status === 'present').length;
                const absent = recordsForDate.filter(r => r.status === 'absent').length;
                const late = recordsForDate.filter(r => r.status === 'late').length;

                const div = document.createElement('div');
                div.style.background = 'white';
                div.style.padding = '15px';
                div.style.marginBottom = '15px';
                div.style.borderRadius = '8px';
                div.style.borderLeft = '4px solid var(--color-info)';
                div.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';

                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 15px;">
                        <div>
                            <strong style="font-size: 16px;">${date}</strong>
                            <div style="font-size:13px; color:gray; margin-top:5px;">
                                üìä Class: ${classInfo.code} - ${classInfo.name}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <span style="padding: 4px 8px; background: #d4edda; color: #155724; border-radius: 4px; font-size: 12px;">‚úÖ ${present} Present</span>
                                <span style="padding: 4px 8px; background: #f8d7da; color: #721c24; border-radius: 4px; font-size: 12px;">‚ùå ${absent} Absent</span>
                                <span style="padding: 4px 8px; background: #fff3cd; color: #856404; border-radius: 4px; font-size: 12px;">‚è∞ ${late} Late</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <table style="width:100%; font-size:13px;">
                            <thead>
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <th style="padding: 8px; text-align:left;">Student</th>
                                    <th style="padding: 8px; text-align:left;">Roll No</th>
                                    <th style="padding: 8px; text-align:left;">Status</th>
                                    <th style="padding: 8px; text-align:left;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="records-${date.replace(/-/g, '')}">
                                <!-- Records will be populated here -->
                            </tbody>
                        </table>
                    </div>
                `;

                container.appendChild(div);

                // Populate individual records
                const tbody = document.getElementById(`records-${date.replace(/-/g, '')}`);
                recordsForDate.forEach(record => {
                    const student = allStudents.find(s => s.id === record.studentId) || {};
                    const statusColors = {
                        present: { bg: '#d4edda', color: '#155724', icon: '‚úÖ' },
                        absent: { bg: '#f8d7da', color: '#721c24', icon: '‚ùå' },
                        late: { bg: '#fff3cd', color: '#856404', icon: '‚è∞' }
                    };
                    const status = statusColors[record.status] || statusColors.absent;

                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid #f0f0f0';
                    tr.innerHTML = `
                        <td style="padding: 8px;">${student.firstName || ''} ${student.lastName || ''}</td>
                        <td style="padding: 8px;">${student.rollNo || 'N/A'}</td>
                        <td style="padding: 8px;">
                            <span style="padding: 4px 8px; background: ${status.bg}; color: ${status.color}; border-radius: 4px; font-size: 12px;">
                                ${status.icon} ${record.status}
                            </span>
                        </td>
                        <td style="padding: 8px;">
                            <button class="btn btn-small btn-info" onclick="openEditAttendanceModal(${record.id})">Edit</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        async function downloadHistoryCSV() {
            const classSelect = document.getElementById('historyClassSelect');
            const classId = parseInt(classSelect.value);

            if (!classId) {
                showToast('Please select a class first', 'error');
                return;
            }

            const allAttendance = await getAll('attendance');
            const allStudents = await getAll('students');
            const classRecords = allAttendance.filter(r => r.classId === classId);

            if (classRecords.length === 0) {
                showToast('No history found for this class', 'info');
                return;
            }

            // Map student IDs to details
            const studentMap = new Map(allStudents.map(s => [s.id, s]));

            let csvContent = "Date,Roll No,Name,Status\n";

            // Sort by Date descending
            classRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

            classRecords.forEach(r => {
                const s = studentMap.get(r.studentId) || { firstName: 'Unknown', lastName: '', rollNo: 'N/A' };
                csvContent += `${r.date},${s.rollNo},${s.firstName} ${s.lastName},${r.status}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `attendance_history_class_${classId}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function generateYearlyReport() {
            const tbody = document.getElementById('yearWiseAttendanceBody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Loading stats...</td></tr>';

            const attendance = await getAll('attendance');
            const students = await getAll('students');
            const classes = await getAll('classes'); // Need to know class year

            // Map classId -> Year
            const classYearMap = new Map();
            classes.forEach(c => classYearMap.set(c.id, c.year));

            // Initialize Stats per Year (1,2,3,4)
            const stats = {
                1: { held: 0, present: 0, absent: 0, late: 0 },
                2: { held: 0, present: 0, absent: 0, late: 0 },
                3: { held: 0, present: 0, absent: 0, late: 0 },
                4: { held: 0, present: 0, absent: 0, late: 0 }
            };

            // Aggregate
            attendance.forEach(r => {
                // Try to get year from class, if fails try student year
                let year = classYearMap.get(r.classId);
                if (!year) {
                    const s = students.find(st => st.id === r.studentId);
                    if (s) year = Math.ceil(s.semester / 2); // Approx year from sem
                }

                if (year && stats[year]) {
                    stats[year].held++; // Counting total records as "held opportunities"
                    if (r.status === 'present') stats[year].present++;
                    else if (r.status === 'absent') stats[year].absent++;
                    else if (r.status === 'late') stats[year].late++;
                }
            });

            tbody.innerHTML = '';

            for (let year = 1; year <= 4; year++) {
                const s = stats[year];
                const total = s.present + s.absent + s.late;
                const percent = total > 0 ? Math.round((s.present / total) * 100) : 0;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${year}</td>
                    <td>${total}</td>
                    <td>${s.present}</td>
                    <td>${s.absent}</td>
                    <td>${s.late}</td>
                    <td><strong>${percent}%</strong></td>
                 `;
                tbody.appendChild(row);
            }
        }

        // Edit Attendance Modal Functions
        async function openEditAttendanceModal(attendanceId) {
            const record = await getRecord('attendance', attendanceId);
            if (!record) return;

            const allStudents = await getAll('students');
            const allClasses = await getAll('classes');

            const student = allStudents.find(s => s.id === record.studentId);
            const classInfo = allClasses.find(c => c.id === record.classId);

            document.getElementById('editAttendanceId').value = attendanceId;
            document.getElementById('editAttendanceStudentId').value = record.studentId;

            document.getElementById('editStudentInfo').textContent =
                student ? `${student.firstName} ${student.lastName} (${student.rollNo})` : 'Unknown Student';
            document.getElementById('editClassInfo').textContent =
                classInfo ? `${classInfo.code} - ${classInfo.name}` : 'Unknown Class';
            document.getElementById('editDateInfo').textContent = record.date;
            document.getElementById('editFacultyInfo').textContent =
                classInfo ? classInfo.faculty : 'Unknown Faculty';
            document.getElementById('editAttendanceNotes').value = record.notes || '';

            // Set the correct radio button
            document.querySelector(`input[name="attendanceStatus"][value="${record.status}"]`).checked = true;

            openModal('editAttendanceModal');
        }

        async function saveEditedAttendance(event) {
            event.preventDefault();

            const attendanceId = parseInt(document.getElementById('editAttendanceId').value);
            const record = await getRecord('attendance', attendanceId);

            if (!record) {
                showToast('Record not found!', 'error');
                return;
            }

            const newStatus = document.querySelector('input[name="attendanceStatus"]:checked').value;
            const notes = document.getElementById('editAttendanceNotes').value;

            record.status = newStatus;
            record.notes = notes;
            record.updatedAt = new Date().toISOString();

            await updateRecord('attendance', record);
            showToast('Attendance updated successfully!');
            closeModal('editAttendanceModal');

            // Refresh the current view
            if (currentUser.role === 'faculty') {
                loadAttendanceHistory();
            } else if (currentUser.role === 'admin') {
                loadAdminAttendanceHistory();
            }
        }

        async function deleteAttendanceRecord() {
            const attendanceId = parseInt(document.getElementById('editAttendanceId').value);

            showConfirm('Delete this attendance record permanently?', async function () {
                await deleteRecord('attendance', attendanceId);
                showToast('Attendance record deleted!', 'info');
                closeModal('editAttendanceModal');

                // Refresh the current view
                if (currentUser.role === 'faculty') {
                    loadAttendanceHistory();
                } else if (currentUser.role === 'admin') {
                    loadAdminAttendanceHistory();
                }
            });
        }

        // Admin Attendance History Functions
        async function loadAdminAttendanceHistory() {
            const yearFilter = document.getElementById('adminYearFilter').value;
            const branchFilter = document.getElementById('adminBranchFilter').value;
            const dateFrom = document.getElementById('adminDateFrom').value;
            const dateTo = document.getElementById('adminDateTo').value;
            const statusFilter = document.getElementById('adminStatusFilter').value;
            const sortBy = document.getElementById('adminSortBy').value;

            const allAttendance = await getAll('attendance');
            const allStudents = await getAll('students');
            const allClasses = await getAll('classes');

            let filteredAttendance = allAttendance;

            // Apply filters
            if (yearFilter !== 'all') {
                const yearNum = parseInt(yearFilter);
                const targetSemesters = [yearNum * 2 - 1, yearNum * 2];

                filteredAttendance = filteredAttendance.filter(record => {
                    const student = allStudents.find(s => s.id === record.studentId);
                    if (!student) return false;
                    return targetSemesters.includes(student.semester);
                });
            }

            if (branchFilter !== 'all') {
                filteredAttendance = filteredAttendance.filter(record => {
                    const student = allStudents.find(s => s.id === record.studentId);
                    if (!student) return false;
                    return student.department === branchFilter;
                });
            }

            if (dateFrom) {
                filteredAttendance = filteredAttendance.filter(record => record.date >= dateFrom);
            }

            if (dateTo) {
                filteredAttendance = filteredAttendance.filter(record => record.date <= dateTo);
            }

            if (statusFilter !== 'all') {
                filteredAttendance = filteredAttendance.filter(record => record.status === statusFilter);
            }

            // Sort results
            filteredAttendance.sort((a, b) => {
                switch (sortBy) {
                    case 'date_desc':
                        return new Date(b.date) - new Date(a.date);
                    case 'date_asc':
                        return new Date(a.date) - new Date(b.date);
                    case 'student_asc':
                        const studentA = allStudents.find(s => s.id === a.studentId) || {};
                        const studentB = allStudents.find(s => s.id === b.studentId) || {};
                        return `${studentA.firstName} ${studentA.lastName}`.localeCompare(`${studentB.firstName} ${studentB.lastName}`);
                    case 'student_desc':
                        const studentC = allStudents.find(s => s.id === a.studentId) || {};
                        const studentD = allStudents.find(s => s.id === b.studentId) || {};
                        return `${studentD.firstName} ${studentD.lastName}`.localeCompare(`${studentC.firstName} ${studentC.lastName}`);
                    default:
                        return 0;
                }
            });

            // Update statistics
            updateAdminStats(filteredAttendance);

            // Display results
            const tbody = document.getElementById('adminAttendanceBody');
            tbody.innerHTML = '';

            if (filteredAttendance.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align:center; padding: 40px; color: gray;">
                            No attendance records found with the current filters.
                        </td>
                    </tr>
                `;
                return;
            }

            filteredAttendance.forEach(record => {
                const student = allStudents.find(s => s.id === record.studentId) || {};
                const classInfo = allClasses.find(c => c.id === record.classId) || {};

                const statusColors = {
                    present: { bg: '#d4edda', color: '#155724', text: 'Present' },
                    absent: { bg: '#f8d7da', color: '#721c24', text: 'Absent' },
                    late: { bg: '#fff3cd', color: '#856404', text: 'Late' }
                };
                const status = statusColors[record.status] || statusColors.absent;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${record.date}</td>
                    <td>${student.rollNo || 'N/A'}</td>
                    <td>${student.firstName || ''} ${student.lastName || ''}</td>
                    <td>${student.department || 'N/A'}</td>
                    <td>${Math.ceil((student.semester || 1) / 2)}</td>
                    <td>${student.semester || 'N/A'}</td>
                    <td>${classInfo.code || 'N/A'} - ${classInfo.name || 'N/A'}</td>
                    <td>${classInfo.faculty || 'N/A'}</td>
                    <td>
                        <span style="padding: 4px 8px; background: ${status.bg}; color: ${status.color}; border-radius: 4px; font-size: 12px;">
                            ${status.text}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-small btn-info" onclick="openEditAttendanceModal(${record.id})">Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteAdminAttendanceRecord(${record.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('adminRecordCount').textContent = `(${filteredAttendance.length})`;
        }

        function updateAdminStats(records) {
            const total = records.length;
            const present = records.filter(r => r.status === 'present').length;
            const absent = records.filter(r => r.status === 'absent').length;
            const late = records.filter(r => r.status === 'late').length;

            document.getElementById('statTotalRecords').textContent = total;
            document.getElementById('statPresentCount').textContent = present;
            document.getElementById('statAbsentCount').textContent = absent;
            document.getElementById('statLateCount').textContent = late;
        }

        function clearAdminFilters() {
            document.getElementById('adminYearFilter').value = 'all';
            document.getElementById('adminBranchFilter').value = 'all';
            document.getElementById('adminDateFrom').value = '';
            document.getElementById('adminDateTo').value = '';
            document.getElementById('adminStatusFilter').value = 'all';
            document.getElementById('adminSortBy').value = 'date_desc';
            loadAdminAttendanceHistory();
        }

        async function deleteAdminAttendanceRecord(id) {
            showConfirm('Delete this attendance record?', async function () {
                await deleteRecord('attendance', id);
                showToast('Record deleted!', 'info');
                loadAdminAttendanceHistory();
            });
        }

        // Export Functions
        async function exportAdminHistory(format) {
            const yearFilter = document.getElementById('adminYearFilter').value;
            const branchFilter = document.getElementById('adminBranchFilter').value;
            const dateFrom = document.getElementById('adminDateFrom').value;
            const dateTo = document.getElementById('adminDateTo').value;

            const allAttendance = await getAll('attendance');
            const allStudents = await getAll('students');
            const allClasses = await getAll('classes');

            let filteredData = allAttendance.map(record => {
                const student = allStudents.find(s => s.id === record.studentId) || {};
                const classInfo = allClasses.find(c => c.id === record.classId) || {};

                return {
                    date: record.date,
                    studentRollNo: student.rollNo || 'N/A',
                    studentName: `${student.firstName || ''} ${student.lastName || ''}`,
                    department: student.department || 'N/A',
                    year: Math.ceil((student.semester || 1) / 2),
                    semester: student.semester || 'N/A',
                    classCode: classInfo.code || 'N/A',
                    className: classInfo.name || 'N/A',
                    faculty: classInfo.faculty || 'N/A',
                    status: record.status,
                    notes: record.notes || ''
                };
            });

            // Apply same filters as display
            if (yearFilter !== 'all') {
                const yearNum = parseInt(yearFilter);
                filteredData = filteredData.filter(item => item.year === yearNum);
            }

            if (branchFilter !== 'all') {
                filteredData = filteredData.filter(item => item.department === branchFilter);
            }

            if (dateFrom) {
                filteredData = filteredData.filter(item => item.date >= dateFrom);
            }

            if (dateTo) {
                filteredData = filteredData.filter(item => item.date <= dateTo);
            }

            switch (format) {
                case 'csv':
                    exportToCSV(filteredData);
                    break;
                case 'excel':
                    exportToExcel(filteredData);
                    break;
                case 'json':
                    exportToJSON(filteredData);
                    break;
                case 'pdf':
                    exportToPDF(filteredData);
                    break;
            }
        }

        function exportToCSV(data) {
            if (data.length === 0) {
                showToast('No data to export', 'error');
                return;
            }

            const headers = Object.keys(data[0]).join(',');
            const rows = data.map(item =>
                Object.values(item).map(value =>
                    `"${String(value).replace(/"/g, '""')}"`
                ).join(',')
            );

            const csvContent = [headers, ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `attendance_history_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('CSV exported successfully!');
        }

        function exportToExcel(data) {
            if (data.length === 0) {
                showToast('No data to export', 'error');
                return;
            }

            // Create HTML table for Excel
            let html = '<html><head><meta charset="UTF-8"></head><body>';
            html += '<table border="1">';

            // Headers
            html += '<tr>';
            Object.keys(data[0]).forEach(key => {
                html += `<th>${key}</th>`;
            });
            html += '</tr>';

            // Data rows
            data.forEach(item => {
                html += '<tr>';
                Object.values(item).forEach(value => {
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });

            html += '</table></body></html>';

            const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `attendance_history_${new Date().getTime()}.xls`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('Excel file exported successfully!');
        }

        function exportToJSON(data) {
            if (data.length === 0) {
                showToast('No data to export', 'error');
                return;
            }

            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `attendance_history_${new Date().getTime()}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('JSON exported successfully!');
        }

        function exportToPDF(data) {
            if (data.length === 0) {
                showToast('No data to export', 'error');
                return;
            }

            // Simple PDF generation using window.print()
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Attendance Report</title>');
            printWindow.document.write('<style>body { font-family: Arial; margin: 20px; } table { width: 100%; border-collapse: collapse; margin-top: 20px; } th, td { border: 1px solid #ddd; padding: 8px; text-align: left; } th { background-color: #f2f2f2; }</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<h1>Attendance History Report</h1>');
            printWindow.document.write(`<p>Generated: ${new Date().toLocaleString()}</p>`);
            printWindow.document.write(`<p>Total Records: ${data.length}</p>`);

            printWindow.document.write('<table>');
            printWindow.document.write('<tr>');
            Object.keys(data[0]).forEach(key => {
                printWindow.document.write(`<th>${key}</th>`);
            });
            printWindow.document.write('</tr>');

            data.forEach(item => {
                printWindow.document.write('<tr>');
                Object.values(item).forEach(value => {
                    printWindow.document.write(`<td>${value}</td>`);
                });
                printWindow.document.write('</tr>');
            });

            printWindow.document.write('</table>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();

            setTimeout(() => {
                printWindow.print();
                showToast('PDF generated! Use print dialog to save as PDF.');
            }, 500);
        }

        // --- BULK EXPORT FUNCTIONS ---
        async function exportBulkData(type) {
            switch (type) {
                case 'students':
                    await exportStudentsYearWise();
                    break;
                case 'classes':
                    await exportClassesYearWise();
                    break;
                case 'faculty':
                    await exportAllFaculty();
                    break;
            }
        }

        async function exportStudentsYearWise() {
            const allStudents = await getAll('students');
            if (allStudents.length === 0) {
                showToast('No students to export', 'error');
                return;
            }

            // Group by year
            const studentsByYear = {};
            allStudents.forEach(student => {
                const year = student.year || Math.ceil(student.semester / 2);
                if (!studentsByYear[year]) {
                    studentsByYear[year] = [];
                }
                studentsByYear[year].push(student);
            });

            let csvContent = '';

            // Export each year separately
            for (const year in studentsByYear) {
                const yearStudents = studentsByYear[year];

                const headers = [
                    'Roll No', 'First Name', 'Last Name', 'Email',
                    'Department', 'Year', 'Semester', 'Created Date'
                ];

                csvContent += `--- Year ${year} Students (${yearStudents.length} records) ---\n`;
                csvContent += headers.join(',') + '\n';

                yearStudents.forEach(student => {
                    const row = [
                        `"${student.rollNo || ''}"`,
                        `"${student.firstName || ''}"`,
                        `"${student.lastName || ''}"`,
                        `"${student.email || ''}"`,
                        `"${student.department || ''}"`,
                        student.year || '',
                        student.semester || '',
                        `"${new Date(student.createdAt).toLocaleDateString()}"`
                    ];
                    csvContent += row.join(',') + '\n';
                });

                csvContent += '\n'; // Add blank line between years
            }

            downloadCSV(csvContent, `students_export_yearwise_${new Date().getTime()}.csv`);
            showToast(`Exported ${allStudents.length} students grouped by year`);
        }

        async function exportClassesYearWise() {
            const allClasses = await getAll('classes');
            if (allClasses.length === 0) {
                showToast('No classes to export', 'error');
                return;
            }

            // Group by year
            const classesByYear = {};
            allClasses.forEach(cls => {
                const year = cls.year;
                if (!classesByYear[year]) {
                    classesByYear[year] = [];
                }
                classesByYear[year].push(cls);
            });

            let csvContent = '';

            // Export each year separately
            for (const year in classesByYear) {
                const yearClasses = classesByYear[year];

                const headers = [
                    'Class Code', 'Course Name', 'Department', 'Semester',
                    'Faculty', 'Year', 'Credits', 'Created Date'
                ];

                csvContent += `--- Year ${year} Classes (${yearClasses.length} records) ---\n`;
                csvContent += headers.join(',') + '\n';

                yearClasses.forEach(cls => {
                    const row = [
                        `"${cls.code || ''}"`,
                        `"${cls.name || ''}"`,
                        `"${cls.department || ''}"`,
                        cls.semester || '',
                        `"${cls.faculty || ''}"`,
                        cls.year || '',
                        cls.credits || '3',
                        `"${new Date(cls.createdAt).toLocaleDateString()}"`
                    ];
                    csvContent += row.join(',') + '\n';
                });

                csvContent += '\n'; // Add blank line between years
            }

            downloadCSV(csvContent, `classes_export_yearwise_${new Date().getTime()}.csv`);
            showToast(`Exported ${allClasses.length} classes grouped by year`);
        }

        async function exportAllFaculty() {
            const allFaculty = await getAll('faculty');
            if (allFaculty.length === 0) {
                showToast('No faculty to export', 'error');
                return;
            }

            const headers = [
                'Faculty ID', 'First Name', 'Last Name', 'Email',
                'Department', 'Specialization', 'Created Date'
            ];

            let csvContent = headers.join(',') + '\n';

            allFaculty.forEach(faculty => {
                const row = [
                    `"${faculty.facultyId || ''}"`,
                    `"${faculty.firstName || ''}"`,
                    `"${faculty.lastName || ''}"`,
                    `"${faculty.email || ''}"`,
                    `"${faculty.department || ''}"`,
                    `"${faculty.specialization || ''}"`,
                    `"${new Date(faculty.createdAt).toLocaleDateString()}"`
                ];
                csvContent += row.join(',') + '\n';
            });

            downloadCSV(csvContent, `faculty_export_${new Date().getTime()}.csv`);
            showToast(`Exported ${allFaculty.length} faculty members`);
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Export all data in one ZIP file
        async function exportAllInOne() {
            showToast('Preparing bulk export...', 'info');

            try {
                // Get all data
                const students = await getAll('students');
                const faculty = await getAll('faculty');
                const classes = await getAll('classes');

                if (students.length === 0 && faculty.length === 0 && classes.length === 0) {
                    showToast('No data to export', 'error');
                    return;
                }

                // Create CSV for each type
                const timestamp = new Date().getTime();
                const files = [];

                // Students CSV
                if (students.length > 0) {
                    let studentCSV = 'Roll No,First Name,Last Name,Email,Department,Year,Semester,Created Date\n';
                    students.forEach(student => {
                        studentCSV += [
                            `"${student.rollNo || ''}"`,
                            `"${student.firstName || ''}"`,
                            `"${student.lastName || ''}"`,
                            `"${student.email || ''}"`,
                            `"${student.department || ''}"`,
                            student.year || '',
                            student.semester || '',
                            `"${new Date(student.createdAt).toLocaleDateString()}"`
                        ].join(',') + '\n';
                    });
                    files.push({ name: `students_${timestamp}.csv`, content: studentCSV });
                }

                // Faculty CSV
                if (faculty.length > 0) {
                    let facultyCSV = 'Faculty ID,First Name,Last Name,Email,Department,Specialization,Created Date\n';
                    faculty.forEach(fac => {
                        facultyCSV += [
                            `"${fac.facultyId || ''}"`,
                            `"${fac.firstName || ''}"`,
                            `"${fac.lastName || ''}"`,
                            `"${fac.email || ''}"`,
                            `"${fac.department || ''}"`,
                            `"${fac.specialization || ''}"`,
                            `"${new Date(fac.createdAt).toLocaleDateString()}"`
                        ].join(',') + '\n';
                    });
                    files.push({ name: `faculty_${timestamp}.csv`, content: facultyCSV });
                }

                // Classes CSV
                if (classes.length > 0) {
                    let classCSV = 'Class Code,Course Name,Department,Semester,Faculty,Year,Credits,Created Date\n';
                    classes.forEach(cls => {
                        classCSV += [
                            `"${cls.code || ''}"`,
                            `"${cls.name || ''}"`,
                            `"${cls.department || ''}"`,
                            cls.semester || '',
                            `"${cls.faculty || ''}"`,
                            cls.year || '',
                            cls.credits || '3',
                            `"${new Date(cls.createdAt).toLocaleDateString()}"`
                        ].join(',') + '\n';
                    });
                    files.push({ name: `classes_${timestamp}.csv`, content: classCSV });
                }

                // If only one file, download it directly
                if (files.length === 1) {
                    downloadCSV(files[0].content, files[0].name);
                    showToast(`Exported ${files[0].name}`, 'success');
                    return;
                }

                // For multiple files, create a zip using JSZip
                if (typeof JSZip === 'undefined') {
                    // If JSZip not available, download files separately
                    files.forEach(file => {
                        downloadCSV(file.content, file.name);
                    });
                    showToast(`Exported ${files.length} files separately`, 'success');
                } else {
                    // Create ZIP with JSZip
                    const zip = new JSZip();
                    files.forEach(file => {
                        zip.file(file.name, file.content);
                    });

                    zip.generateAsync({ type: "blob" }).then(content => {
                        const link = document.createElement("a");
                        const url = URL.createObjectURL(content);
                        link.setAttribute("href", url);
                        link.setAttribute("download", `attendance_system_export_${timestamp}.zip`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showToast(`Exported ${files.length} files in ZIP`, 'success');
                    });
                }

            } catch (error) {
                console.error('Export error:', error);
                showToast('Error during export', 'error');
            }
        }

        async function updateExportStats() {
            const students = await getAll('students');
            const faculty = await getAll('faculty');
            const classes = await getAll('classes');

            document.getElementById('exportStudentCount').textContent = students.length;
            document.getElementById('exportFacultyCount').textContent = faculty.length;
            document.getElementById('exportClassCount').textContent = classes.length;
        }

        // --- CLASS FILTERING LOGIC ---
        function filterClasses(year) {
            activeClassFilter.year = year;
            activeClassFilter.semester = null;
            const buttons = document.getElementById('classYearFilterGroup').children;
            for (let btn of buttons) {
                btn.classList.remove('active');
            }
            event.target.classList.add('active');
            const semContainer = document.getElementById('classSemesterFilterGroup');
            const semButtons = document.getElementById('classSemesterButtons');
            semButtons.innerHTML = '';
            if (year === 'all') {
                semContainer.style.display = 'none';
            } else {
                semContainer.style.display = 'block';
                const startSem = (year - 1) * 2 + 1;
                const endSem = startSem + 1;
                const allBtn = document.createElement('button');
                allBtn.className = 'filter-btn active';
                allBtn.textContent = 'All';
                allBtn.onclick = (e) => filterClassesBySemester(null, e);
                semButtons.appendChild(allBtn);
                for (let i = startSem; i <= endSem; i++) {
                    const btn = document.createElement('button');
                    btn.className = 'filter-btn';
                    btn.textContent = `Sem ${i}`;
                    btn.onclick = (e) => filterClassesBySemester(i, e);
                    semButtons.appendChild(btn);
                }
            }
            loadClasses();
        }

        function filterClassesBySemester(sem, event) {
            activeClassFilter.semester = sem;
            const buttons = document.getElementById('classSemesterButtons').children;
            for (let btn of buttons) {
                btn.classList.remove('active');
            }
            event.target.classList.add('active');
            loadClasses();
        }

        // --- FILTERING & SELECTION LOGIC (Student Panel) ---
        function filterStudents(year) {
            activeStudentFilter.year = year;
            activeStudentFilter.semester = null;
            selectedStudentIds.clear();
            document.getElementById('masterCheckbox').checked = false;
            const buttons = document.getElementById('yearFilterGroup').children;
            for (let btn of buttons) {
                btn.classList.remove('active');
            }
            event.target.classList.add('active');
            const semContainer = document.getElementById('semesterFilterGroup');
            const semButtons = document.getElementById('semesterButtons');
            semButtons.innerHTML = '';
            if (year === 'all') {
                semContainer.style.display = 'none';
            } else {
                semContainer.style.display = 'block';
                const startSem = (year - 1) * 2 + 1;
                const endSem = startSem + 1;
                const allBtn = document.createElement('button');
                allBtn.className = 'filter-btn active';
                allBtn.textContent = 'All';
                allBtn.onclick = (e) => filterBySemester(null, e);
                semButtons.appendChild(allBtn);
                for (let i = startSem; i <= endSem; i++) {
                    const btn = document.createElement('button');
                    btn.className = 'filter-btn';
                    btn.textContent = `Sem ${i}`;
                    btn.onclick = (e) => filterBySemester(i, e);
                    semButtons.appendChild(btn);
                }
            }
            loadStudents();
        }

        function filterBySemester(sem, event) {
            activeStudentFilter.semester = sem;
            selectedStudentIds.clear();
            document.getElementById('masterCheckbox').checked = false;
            const buttons = document.getElementById('semesterButtons').children;
            for (let btn of buttons) {
                btn.classList.remove('active');
            }
            event.target.classList.add('active');
            loadStudents();
        }

        function filterByBranch(branch) {
            activeStudentFilter.branch = branch;
            selectedStudentIds.clear();
            document.getElementById('masterCheckbox').checked = false;
            loadStudents();
        }

        function handleCheckboxChange(checkbox) {
            const studentId = parseInt(checkbox.value);
            if (checkbox.checked) {
                selectedStudentIds.add(studentId);
            } else {
                selectedStudentIds.delete(studentId);
                document.getElementById('masterCheckbox').checked = false;
            }
            updateSelectionUI();
        }

        function toggleSelectAll() {
            const masterCheckbox = document.getElementById('masterCheckbox');
            const isChecked = masterCheckbox.checked;
            const checkboxes = document.querySelectorAll('.student-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = isChecked;
                const id = parseInt(cb.value);
                if (isChecked) {
                    selectedStudentIds.add(id);
                } else {
                    selectedStudentIds.delete(id);
                }
            });
            updateSelectionUI();
        }

        function selectAllListed() {
            displayedStudents.forEach(s => selectedStudentIds.add(s.id));
            document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = true);
            document.getElementById('masterCheckbox').checked = true;
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const banner = document.getElementById('selectAllBanner');
            const count = selectedStudentIds.size;
            const targets = document.querySelectorAll('.action-target-text');
            targets.forEach(el => {
                if (count > 0) {
                    el.textContent = `Selected (${count})`;
                } else {
                    el.textContent = 'All Listed';
                }
            });
            if (count >= 4 && count < displayedStudents.length) {
                banner.style.display = 'flex';
                document.getElementById('selectAllText').textContent = `You have selected ${count} students.`;
                document.getElementById('selectAllCount').textContent = displayedStudents.length;
            } else {
                banner.style.display = 'none';
            }
        }

        function getTargetStudents() {
            if (selectedStudentIds.size > 0) {
                return displayedStudents.filter(s => selectedStudentIds.has(s.id));
            }
            return displayedStudents;
        }

        // --- CORE LOGIC ---
        function switchAdminTab(tabName) {
            document.querySelectorAll('#adminPanel .tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#adminPanel .tab-btn').forEach(b => b.classList.remove('active'));
            const tabId = 'admin' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');

            // Update export statistics when bulk export tab is opened
            if (tabName === 'bulkExport') {
                updateExportStats();
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function openBulkAttendanceModal() {
            const classSelect = document.getElementById('facultyClassSelect');
            if (!classSelect.value) {
                showToast('Please select a class first!', 'error');
                return;
            }
            document.getElementById('bulkAttendanceInput').value = '';
            openModal('bulkAttendanceModal');
        }

        async function saveBulkAttendance() {
            const classId = parseInt(document.getElementById('facultyClassSelect').value);
            if (!classId) return;

            const date = document.getElementById('attendanceDate').value;
            if (!date) {
                showToast('Please select a date first', 'error');
                return;
            }

            const input = document.getElementById('bulkAttendanceInput').value;
            const lines = input.split(/\r\n|\n|\r/);

            const allStudents = await getAll('students');
            const allAttendance = await getAll('attendance');

            let successCount = 0;

            for (let line of lines) {
                if (!line.trim()) continue;
                const parts = line.split(',').map(s => s.trim());
                const rollNo = parts[0];
                const statusKey = parts.length > 1 ? parts[1].toUpperCase() : 'P';

                // Validate status
                let status = 'present';
                if (statusKey === 'A') status = 'absent';
                else if (statusKey === 'L') status = 'late';

                // Find student
                const student = allStudents.find(s => s.rollNo === rollNo);
                if (student) {
                    // Check existing
                    const existingRecord = allAttendance.find(r => r.classId === classId && r.studentId === student.id && r.date === date);

                    const record = {
                        classId: classId,
                        studentId: student.id,
                        date: date,
                        status: status,
                        createdAt: new Date().toISOString()
                    };

                    if (existingRecord) {
                        record.id = existingRecord.id; // Preserve ID for update
                        await updateRecord('attendance', record);
                    } else {
                        await addRecord('attendance', record);
                    }

                    successCount++;

                    // Update UI if student card exists
                    const card = document.getElementById(`student-card-${student.id}`);
                    if (card) {
                        const checkbox = card.querySelector('.attendance-checkbox');
                        if (checkbox) {
                            checkbox.checked = (status === 'present');
                        }
                    }
                }
            }

            showToast(`Processed ${successCount} attendance records`, 'success');
            closeModal('bulkAttendanceModal');
            generateYearlyReport(); // Live sync
        }

        async function submitAttendance() {
            const classSelect = document.getElementById('facultyClassSelect');
            const classId = parseInt(classSelect.value);
            const date = document.getElementById('attendanceDate').value;

            if (!classId || !date) {
                showToast('Please select Class and Date', 'error');
                return;
            }

            const checkboxes = document.querySelectorAll('.attendance-checkbox');
            if (checkboxes.length === 0) {
                showToast('No students to mark', 'error');
                return;
            }

            // Pre-fetch existing records to avoid duplication
            const allAttendance = await getAll('attendance');
            const existingForDay = allAttendance.filter(r => r.classId === classId && r.date === date);
            const existingMap = new Map(existingForDay.map(r => [r.studentId, r]));

            const promises = [];

            checkboxes.forEach(cb => {
                const studentId = parseInt(cb.value);
                const status = cb.checked ? 'present' : 'absent';

                const record = {
                    classId: classId,
                    studentId: studentId,
                    date: date,
                    status: status,
                    createdAt: new Date().toISOString()
                };

                const existing = existingMap.get(studentId);
                if (existing) {
                    record.id = existing.id;
                    promises.push(updateRecord('attendance', record));
                } else {
                    promises.push(addRecord('attendance', record));
                }
            });

            try {
                await Promise.all(promises);
                showToast(`Attendance saved for ${checkboxes.length} students!`);
                generateYearlyReport(); // Live sync report
            } catch (e) {
                console.error(e);
                showToast('Error saving attendance', 'error');
            }
        }

        function openBatchClassModal() {
            document.getElementById('batchClassModal').classList.add('show');
            document.getElementById('batchPreviewArea').style.display = 'none';
            document.getElementById('batchPreviewTable').querySelector('tbody').innerHTML = '';
            document.getElementById('batchClassInput').value = '';
        }

        window.onclick = function (event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        }

        // Batch Class Logic
        let parsedBatchClasses = [];

        function previewBatchClasses() {
            const input = document.getElementById('batchClassInput').value;
            const branch = document.getElementById('batchBranch').value;
            const year = document.getElementById('batchYear').value;

            const lines = input.split(/\r\n|\n|\r/);
            const tbody = document.getElementById('batchPreviewTable').querySelector('tbody');
            tbody.innerHTML = '';
            parsedBatchClasses = [];

            lines.forEach(line => {
                if (!line.trim()) return;
                const parts = line.split(',').map(p => p.trim());
                if (parts.length >= 4) {
                    const cls = {
                        semester: parseInt(parts[0]),
                        name: parts[1],
                        code: parts[2],
                        faculty: parts[3],
                        department: branch,
                        year: parseInt(year),
                        credits: 3,
                        createdAt: new Date().toISOString()
                    };
                    parsedBatchClasses.push(cls);
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${cls.semester}</td><td>${cls.name}</td><td>${cls.code}</td><td>${cls.faculty}</td>`;
                    tbody.appendChild(tr);
                }
            });

            if (parsedBatchClasses.length > 0) {
                document.getElementById('batchPreviewArea').style.display = 'block';
            } else {
                showToast('No valid lines found. Format: Sem, Name, Code, Faculty', 'error');
            }
        }

        async function saveBatchClasses() {
            try {
                const allFaculty = await getAll('faculty');
                const existingFacultyNames = new Set(allFaculty.map(f => `${f.firstName} ${f.lastName}`.toLowerCase().trim()));
                const newFacultyMap = new Map();

                parsedBatchClasses.forEach(cls => {
                    const facName = cls.faculty.trim();
                    if (!facName) return;
                    const facNameLower = facName.toLowerCase();

                    if (!existingFacultyNames.has(facNameLower) && !newFacultyMap.has(facNameLower)) {
                        const nameParts = facName.split(' ');
                        let firstName = nameParts[0];
                        let lastName = nameParts.slice(1).join(' ');
                        if (!lastName) lastName = '.';

                        let deducedDept = '';
                        const subj = cls.name.toLowerCase();
                        const code = cls.code.toLowerCase();

                        if (subj.includes('security') || subj.includes('cyber')) deducedDept = 'CSE(Cyber Security)';
                        else if (subj.includes('network')) deducedDept = 'CSE(Networks)';
                        else if (subj.includes('computer') || subj.includes('data') || subj.includes('programming') || subj.includes('algorithm') || code.startsWith('cs')) deducedDept = 'Computer Science';
                        else if (subj.includes('civil') || subj.includes('structure') || subj.includes('concrete') || code.startsWith('ce')) deducedDept = 'Civil';
                        else if (subj.includes('mech') || subj.includes('thermo') || subj.includes('fluid') || code.startsWith('me')) deducedDept = 'Mechanical';
                        else if (subj.includes('electric') || subj.includes('power') || code.startsWith('ee')) deducedDept = 'Electrical';
                        else if (subj.includes('electronic') || subj.includes('signal') || subj.includes('digital') || code.startsWith('ec')) deducedDept = 'ECE';
                        else if (subj.includes('physics') || subj.includes('chemistry') || subj.includes('math') || subj.includes('english')) deducedDept = 'Applied Science';
                        else deducedDept = cls.department;

                        const newFaculty = {
                            facultyId: '',
                            firstName: firstName,
                            lastName: lastName,
                            email: 'N/A',
                            department: deducedDept,
                            specialization: cls.name,
                            password: 'pass123',
                            createdAt: new Date().toISOString()
                        };
                        newFacultyMap.set(facNameLower, newFaculty);
                    }
                });

                if (newFacultyMap.size > 0) {
                    const facultyPromises = Array.from(newFacultyMap.values()).map(f => addRecord('faculty', f));
                    await Promise.all(facultyPromises);
                    showToast(`Created ${newFacultyMap.size} new faculty profiles (Default Password: pass123)`, 'info');
                    await loadFaculty();
                }

                const classPromises = parsedBatchClasses.map(cls => addRecord('classes', cls));
                await Promise.all(classPromises);

                showToast(`Successfully created ${parsedBatchClasses.length} classes!`);
                closeModal('batchClassModal');
                loadClasses();
            } catch (e) {
                console.error(e);
                showToast('Error saving classes', 'error');
            }
        }

        // Add Student
        async function addStudent(event) {
            event.preventDefault();
            const student = {
                rollNo: document.getElementById('studentRollNo').value,
                firstName: document.getElementById('studentFirstName').value,
                lastName: document.getElementById('studentLastName').value,
                email: document.getElementById('studentEmail').value,
                department: document.getElementById('studentDept').value,
                year: parseInt(document.getElementById('studentYear').value),
                semester: parseInt(document.getElementById('studentSemester').value),
                createdAt: new Date().toISOString()
            };
            await addRecord('students', student);
            showToast('Student added successfully!');
            event.target.reset();
            closeModal('addUserModal');
            loadStudents();
        }

        function autoFillStudentDetails() {
            const regNo = document.getElementById('studentRollNo').value;
            if (regNo.length < 5) return;
            const yearCode = regNo.substring(0, 2);
            const branchCode = regNo.substring(2, 5);
            let isLateral = false;
            if (regNo.length >= 11) {
                const serial = parseInt(regNo.substring(8, 11));
                if (serial >= 901) isLateral = true;
            }
            let batchYear = 2000 + parseInt(yearCode);
            if (isLateral) batchYear += 1;
            const department = branchMap[branchCode];
            if (department) document.getElementById('studentDept').value = department;
            if (!isNaN(batchYear)) document.getElementById('studentYear').value = batchYear;
        }

        // Load Students
        async function loadStudents() {
            const allStudents = await getAll('students');
            const tbody = document.getElementById('usersTableBody');
            const bulkContainer = document.getElementById('bulkActionContainer');
            const countLabel = document.getElementById('studentCount');
            tbody.innerHTML = '';
            displayedStudents = allStudents.filter(student => {
                if (activeStudentFilter.year !== 'all') {
                    const sem = student.semester;
                    const expectedMinSem = (activeStudentFilter.year - 1) * 2 + 1;
                    const expectedMaxSem = expectedMinSem + 1;
                    if (sem < expectedMinSem || sem > expectedMaxSem) return false;
                }
                if (activeStudentFilter.semester !== null) {
                    if (student.semester !== activeStudentFilter.semester) return false;
                }
                if (activeStudentFilter.branch !== 'all') {
                    if (student.department !== activeStudentFilter.branch) return false;
                }
                return true;
            });
            displayedStudents.forEach(student => {
                const isSelected = selectedStudentIds.has(student.id);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><input type="checkbox" class="student-checkbox" value="${student.id}" onchange="handleCheckboxChange(this)" ${isSelected ? 'checked' : ''}></td><td>${student.rollNo || ''}</td><td>${student.firstName || ''} ${student.lastName || ''}</td><td>${student.department || ''}</td><td>${student.year || ''}</td><td><span class="status-badge" style="background:#eaf6fd; color:#2c5282;">Sem ${student.semester || ''}</span></td><td><button class="btn btn-small btn-danger" onclick="deleteStudent(${student.id})">Delete</button></td>`;
                tbody.appendChild(tr);
            });
            countLabel.textContent = `(${displayedStudents.length})`;
            if (activeStudentFilter.year !== 'all' && displayedStudents.length > 0) {
                bulkContainer.style.display = 'flex';
            } else {
                bulkContainer.style.display = 'none';
            }
            updateSelectionUI();
            updateDashboard();
        }

        // Delete Student
        async function deleteStudent(id) {
            showConfirm('Delete this student record permanently?', async function () {
                await deleteRecord('students', id);
                selectedStudentIds.delete(id);
                showToast('Student deleted successfully', 'info');
                loadStudents();
            });
        }

        function promoteFilteredStudents() {
            const targets = getTargetStudents();
            if (targets.length === 0) { showToast("No students to promote!", "error"); return; }
            const type = selectedStudentIds.size > 0 ? "SELECTED" : "LISTED";
            showConfirm(`Are you sure you want to promote these ${targets.length} ${type} students?`, async function () {
                let updatedCount = 0;
                for (const student of targets) {
                    const newSem = student.semester + 1;
                    student.semester = newSem > 8 ? 9 : newSem;
                    student.year = Math.ceil(student.semester / 2);
                    await updateRecord('students', student);
                    updatedCount++;
                }
                showToast(`Promoted ${updatedCount} students!`);
                selectedStudentIds.clear();
                loadStudents();
            });
        }

        function setBulkSemester() {
            const targets = getTargetStudents();
            if (targets.length === 0) { showToast("No students to update!", "error"); return; }
            const targetSem = parseInt(document.getElementById('bulkSemSelect').value);
            showConfirm(`Move ${targets.length} students to Semester ${targetSem}?`, async function () {
                let updatedCount = 0;
                for (const student of targets) {
                    student.semester = targetSem;
                    student.year = Math.ceil(targetSem / 2);
                    await updateRecord('students', student);
                    updatedCount++;
                }
                showToast(`Updated ${updatedCount} students!`);
                selectedStudentIds.clear();
                loadStudents();
            });
        }

        function deleteFilteredStudents() {
            const targets = getTargetStudents();
            if (targets.length === 0) { showToast("No students to delete!", "error"); return; }
            showConfirm(`‚ö†Ô∏è DANGER: Permanently delete ${targets.length} students?`, async function () {
                const deletePromises = targets.map(student => deleteRecord('students', student.id));
                await Promise.all(deletePromises);
                showToast(`Deleted ${targets.length} students!`, 'success');
                selectedStudentIds.clear();
                loadStudents();
            });
        }

        async function clearAllStudents() {
            showConfirm("‚ö†Ô∏è EXTREME DANGER: Delete ALL students permanently?", async function () {
                await clearStore('students');
                showToast("All students deleted", "success");
                loadStudents();
            });
        }

        // Add Faculty
        async function addFaculty(event) {
            event.preventDefault();
            const faculty = {
                facultyId: document.getElementById('facultyId').value,
                password: document.getElementById('facultyPassword').value,
                firstName: document.getElementById('facultyFirstName').value,
                lastName: document.getElementById('facultyLastName').value,
                email: document.getElementById('facultyEmail').value || 'N/A',
                department: document.getElementById('facultyDept').value,
                specialization: document.getElementById('facultySpecial').value || 'N/A',
                createdAt: new Date().toISOString()
            };
            await addRecord('faculty', faculty);
            showToast('Faculty added successfully!');
            event.target.reset();
            closeModal('addFacultyModal');
            loadFaculty();
        }

        // EDIT FACULTY SYSTEM
        async function openEditFacultyModal(id) {
            const faculty = await getRecord('faculty', id);
            if (!faculty) return;
            document.getElementById('editFacultyIdKey').value = faculty.id;
            document.getElementById('editFacultyId').value = faculty.facultyId;
            document.getElementById('editFacultyFirstName').value = faculty.firstName;
            document.getElementById('editFacultyLastName').value = faculty.lastName;
            document.getElementById('editFacultyEmail').value = faculty.email;
            document.getElementById('editFacultyDept').value = faculty.department;
            document.getElementById('editFacultySpecial').value = faculty.specialization || '';
            document.getElementById('editFacultyPassword').value = '';

            const classes = await getAll('classes');
            const deptClasses = classes.filter(c => c.department === faculty.department);
            const container = document.getElementById('editFacultyClassesList');
            container.innerHTML = '';
            const facultyFullName = `${faculty.firstName} ${faculty.lastName}`;

            if (deptClasses.length === 0) {
                container.innerHTML = '<p style="color:#999;">No classes found for this department.</p>';
            } else {
                deptClasses.forEach(cls => {
                    const isAssigned = cls.faculty === facultyFullName;
                    const div = document.createElement('div');
                    div.className = 'class-assign-item';
                    div.innerHTML = `<input type="checkbox" name="assignedClasses" value="${cls.id}" ${isAssigned ? 'checked' : ''}><span><strong>${cls.code}</strong><br>${cls.name} (Sem ${cls.semester})</span>`;
                    container.appendChild(div);
                });
            }
            openModal('editFacultyModal');
        }

        async function updateFaculty(event) {
            event.preventDefault();
            const idKey = parseInt(document.getElementById('editFacultyIdKey').value);
            const oldFaculty = await getRecord('faculty', idKey);
            const oldName = `${oldFaculty.firstName} ${oldFaculty.lastName}`;
            const newFirstName = document.getElementById('editFacultyFirstName').value;
            const newLastName = document.getElementById('editFacultyLastName').value;
            const newFullName = `${newFirstName} ${newLastName}`;

            const updatedData = {
                id: idKey,
                facultyId: document.getElementById('editFacultyId').value,
                firstName: newFirstName,
                lastName: newLastName,
                email: document.getElementById('editFacultyEmail').value,
                department: document.getElementById('editFacultyDept').value,
                specialization: document.getElementById('editFacultySpecial').value,
                password: document.getElementById('editFacultyPassword').value || oldFaculty.password,
                createdAt: oldFaculty.createdAt
            };
            await updateRecord('faculty', updatedData);

            const checkboxes = document.querySelectorAll('input[name="assignedClasses"]');
            for (let cb of checkboxes) {
                const clsId = parseInt(cb.value);
                const clsRecord = await getRecord('classes', clsId);
                if (cb.checked) {
                    clsRecord.faculty = newFullName;
                    await updateRecord('classes', clsRecord);
                } else if (!cb.checked && clsRecord.faculty === oldName) {
                    clsRecord.faculty = "";
                    await updateRecord('classes', clsRecord);
                }
            }

            if (oldName !== newFullName) {
                const allClasses = await getAll('classes');
                for (let cls of allClasses) {
                    if (cls.faculty === oldName) {
                        cls.faculty = newFullName;
                        await updateRecord('classes', cls);
                    }
                }
            }
            showToast('Faculty updated successfully!');
            closeModal('editFacultyModal');
            document.getElementById('facultyProfileModal').classList.remove('show');
            loadFaculty();
        }

        async function viewFacultyProfile(id) {
            const faculty = await getRecord('faculty', id);
            const classes = await getAll('classes');
            if (!faculty) return;
            const fullName = `${faculty.firstName} ${faculty.lastName}`;
            const myClasses = classes.filter(c => c.faculty === fullName);
            const container = document.getElementById('facultyProfileContent');
            let classRows = '';
            if (myClasses.length === 0) {
                classRows = '<tr><td colspan="4" style="text-align:center; color:gray;">No classes assigned.</td></tr>';
            } else {
                myClasses.forEach(cls => {
                    classRows += `<tr><td><strong>${cls.code}</strong></td><td>${cls.name}</td><td>${cls.semester}</td><td>${cls.year}</td></tr>`;
                });
            }
            container.innerHTML = `<div class="profile-section"><h2 style="color:var(--color-primary); margin-bottom:5px;">${fullName}</h2><span class="status-badge" style="background:#eaf6fd; color:#2c5282; font-size:14px;">${faculty.facultyId}</span></div><div class="profile-info-grid"><div class="profile-info-item"><label>Department</label><div>${faculty.department}</div></div><div class="profile-info-item"><label>Email</label><div>${faculty.email || 'N/A'}</div></div><div class="profile-info-item"><label>Specialization</label><div>${faculty.specialization || 'N/A'}</div></div><div class="profile-info-item"><label>Joined Date</label><div>${new Date(faculty.createdAt).toLocaleDateString()}</div></div></div><h3 style="margin-bottom:15px; font-size:18px; border-bottom:2px solid var(--color-light); padding-bottom:10px;">üìö Assigned Classes Workload</h3><table><thead><tr><th>Code</th><th>Subject Name</th><th>Sem</th><th>Year</th></tr></thead><tbody>${classRows}</tbody></table>`;
            const btn = document.getElementById('btnEditFacultyClasses');
            btn.onclick = function () { openEditFacultyModal(id); };
            document.getElementById('facultyProfileModal').classList.add('show');
        }

        async function loadFaculty() {
            const allFaculty = await getAll('faculty');
            const classes = await getAll('classes');
            const tbody = document.getElementById('facultyTableBody');
            const filterBranch = document.getElementById('facultyBranchFilter').value;
            tbody.innerHTML = '';
            const filteredFaculty = allFaculty.filter(f => filterBranch === 'all' ? true : f.department === filterBranch);
            filteredFaculty.forEach(fac => {
                const fullName = `${fac.firstName} ${fac.lastName}`;
                const myClasses = classes.filter(c => c.faculty === fullName);
                const classBadges = myClasses.map(c => `<span class="assigned-classes-badge">${c.code} (${c.semester})</span>`).join('');
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${fac.facultyId}</td><td><a href="#" onclick="viewFacultyProfile(${fac.id})" style="color:var(--color-primary); font-weight:bold; text-decoration:none;">${fullName}</a></td><td>${classBadges || '<span style="color:#999; font-size:11px;">None</span>'}</td><td>${fac.department}</td><td>${fac.specialization}</td><td><button class="btn btn-small btn-info" onclick="openEditFacultyModal(${fac.id})">Edit</button><button class="btn btn-small btn-danger" onclick="deleteFaculty(${fac.id})">Delete</button></td>`;
                tbody.appendChild(tr);
            });
            const select = document.getElementById('classFaculty');
            select.innerHTML = '<option value="">-- Select Faculty --</option>';
            allFaculty.forEach(fac => {
                const name = `${fac.firstName} ${fac.lastName}`;
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });
            updateDashboard();
        }

        async function deleteFaculty(id) {
            showConfirm('Delete this faculty member?', async function () {
                await deleteRecord('faculty', id);
                showToast('Faculty deleted successfully', 'info');
                loadFaculty();
            });
        }

        async function addClass(event) {
            event.preventDefault();
            const classData = {
                code: document.getElementById('classCode').value,
                name: document.getElementById('courseName').value,
                department: document.getElementById('classDept').value,
                semester: parseInt(document.getElementById('classSemester').value),
                faculty: document.getElementById('classFaculty').value,
                year: parseInt(document.getElementById('classYear').value),
                credits: parseInt(document.getElementById('classCredits').value),
                createdAt: new Date().toISOString()
            };
            await addRecord('classes', classData);
            showToast('Class added successfully!');
            event.target.reset();
            closeModal('addClassModal');
            loadClasses();
        }

        async function updateClass(event) {
            event.preventDefault();
            const id = parseInt(document.getElementById('editClassIdKey').value);
            const updatedData = {
                id: id,
                code: document.getElementById('editClassCode').value,
                name: document.getElementById('editCourseName').value,
                department: document.getElementById('editClassDept').value,
                semester: parseInt(document.getElementById('editClassSemester').value),
                faculty: document.getElementById('editClassFaculty').value,
                year: parseInt(document.getElementById('editClassYear').value),
                credits: parseInt(document.getElementById('editClassCredits').value),
                createdAt: new Date().toISOString()
            };
            const oldRecord = await getRecord('classes', id);
            if (oldRecord) updatedData.createdAt = oldRecord.createdAt;
            await updateRecord('classes', updatedData);
            showToast('Class updated successfully!');
            closeModal('editClassModal');
            loadClasses();
        }

        async function openEditClassModal(id) {
            const cls = await getRecord('classes', id);
            if (!cls) return;
            document.getElementById('editClassIdKey').value = cls.id;
            document.getElementById('editClassCode').value = cls.code;
            document.getElementById('editCourseName').value = cls.name;
            document.getElementById('editClassDept').value = cls.department;
            document.getElementById('editClassSemester').value = cls.semester;
            document.getElementById('editClassYear').value = cls.year;
            document.getElementById('editClassCredits').value = cls.credits;
            const allFaculty = await getAll('faculty');
            const select = document.getElementById('editClassFaculty');
            select.innerHTML = '<option value="">-- Select Faculty --</option>';
            allFaculty.forEach(fac => {
                const name = `${fac.firstName} ${fac.lastName}`;
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                if (name === cls.faculty) opt.selected = true;
                select.appendChild(opt);
            });
            openModal('editClassModal');
        }

        async function loadClasses() {
            const allClasses = await getAll('classes');
            const tbody = document.getElementById('classesTableBody');
            const select = document.getElementById('facultyClassSelect');
            tbody.innerHTML = '';
            const displayedClasses = allClasses.filter(cls => {
                if (activeClassFilter.year !== 'all') {
                    const expectedMinSem = (activeClassFilter.year - 1) * 2 + 1;
                    const expectedMaxSem = expectedMinSem + 1;
                    if (cls.semester < expectedMinSem || cls.semester > expectedMaxSem) return false;
                }
                if (activeClassFilter.semester !== null) {
                    if (cls.semester !== activeClassFilter.semester) return false;
                }
                return true;
            });
            displayedClasses.forEach(cls => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${cls.code}</td><td>${cls.name}</td><td>${cls.department}</td><td>${cls.semester}</td><td>${cls.faculty}</td><td>${cls.year}</td><td>${cls.credits}</td><td><button class="btn btn-small btn-info" onclick="openEditClassModal(${cls.id})">Edit</button><button class="btn btn-small btn-danger" onclick="deleteClass(${cls.id})">Delete</button></td>`;
                tbody.appendChild(tr);
            });
            updateDashboard();
        }

        async function loadClassStudents(dateOverride) {
            const classSelect = document.getElementById('facultyClassSelect');
            const classId = parseInt(classSelect.value);
            const date = dateOverride || document.getElementById('attendanceDate').value;
            if (dateOverride) document.getElementById('attendanceDate').value = dateOverride;

            if (!classId) {
                document.getElementById('studentGrid').innerHTML = '';
                document.getElementById('studentGridContainer').style.display = 'none';
                return;
            }

            const classes = await getAll('classes');
            const selectedClass = classes.find(c => c.id === classId);
            if (!selectedClass) return;

            const allStudents = await getAll('students');
            const classStudents = allStudents.filter(s =>
                s.semester === selectedClass.semester &&
                s.department === selectedClass.department
            );

            const allAttendance = await getAll('attendance');
            const existingAttendance = allAttendance.filter(r => r.classId === classId && r.date === date);
            const attendanceMap = new Map(existingAttendance.map(r => [r.studentId, r.status]));

            const grid = document.getElementById('studentGrid');
            grid.innerHTML = '';

            if (classStudents.length === 0) {
                grid.innerHTML = '<p style="text-align:center; width:100%;">No students found for this class criteria.</p>';
            }

            classStudents.forEach(student => {
                const status = attendanceMap.get(student.id) || 'absent';
                renderStudentCard(student, status === 'present');
            });

            document.getElementById('studentGridContainer').style.display = 'block';
        }

        function renderStudentCard(student, isChecked = false) {
            const grid = document.getElementById('studentGrid');
            if (document.getElementById(`student-card-${student.id}`)) {
                const checkbox = document.querySelector(`#student-card-${student.id} .attendance-checkbox`);
                if (checkbox) checkbox.checked = isChecked;
                return;
            }
            const div = document.createElement('div');
            div.id = `student-card-${student.id}`;
            div.className = 'student-attendance-card';
            div.style.padding = '15px';
            div.style.background = 'white';
            div.style.border = '1px solid #ddd';
            div.style.borderRadius = '8px';
            div.style.display = 'flex';
            div.style.justifyContent = 'space-between';
            div.style.alignItems = 'center';

            div.innerHTML = `<div style="text-align:left;"><div style="font-weight:bold; color:var(--color-dark);">${student.firstName} ${student.lastName}</div><div style="font-size:12px; color:var(--color-gray);">${student.rollNo}</div></div><label class="attendance-toggle"><input type="checkbox" class="attendance-checkbox" value="${student.id}" ${isChecked ? 'checked' : ''}><span class="toggle-label">Present</span></label>`;
            grid.appendChild(div);
        }

        async function addStudentToSession() {
            const input = document.getElementById('addStudentToSessionInput');
            const rollNo = input.value.trim();
            if (!rollNo) { showToast('Please enter a Roll No', 'error'); return; }
            const allStudents = await getAll('students');
            const student = allStudents.find(s => s.rollNo === rollNo);
            if (student) {
                renderStudentCard(student, true);
                showToast(`Added ${student.firstName} to list`, 'success');
                input.value = '';
            } else {
                showToast('Student not found with this Roll No', 'error');
            }
        }

        async function addBatchToSession() {
            const branch = document.getElementById('addBatchBranch').value;
            const sem = parseInt(document.getElementById('addBatchSem').value);
            if (!branch || !sem) { showToast('Please select Branch and Semester', 'error'); return; }
            const allStudents = await getAll('students');
            const targetStudents = allStudents.filter(s => s.department === branch && s.semester === sem);
            if (targetStudents.length === 0) { showToast('No students found for this criteria', 'error'); return; }
            let addedCount = 0;
            targetStudents.forEach(student => {
                if (!document.getElementById(`student-card-${student.id}`)) {
                    renderStudentCard(student);
                    addedCount++;
                }
            });
            if (addedCount > 0) {
                showToast(`Added ${addedCount} students from ${branch} - Sem ${sem}`, 'success');
                document.getElementById('studentGridContainer').style.display = 'block';
            } else {
                showToast('All students from this batch are already in the list', 'info');
            }
        }

        function deleteClass(id) {
            showConfirm('Delete this class?', async function () {
                await deleteRecord('classes', id);
                showToast('Class deleted successfully', 'info');
                loadClasses();
                loadFaculty();
            });
        }

        async function addAcademicYear(event) {
            event.preventDefault();
            const year = {
                year: parseInt(document.getElementById('academicYear').value),
                startDate: document.getElementById('yearStartDate').value,
                endDate: document.getElementById('yearEndDate').value,
                createdAt: new Date().toISOString()
            };
            await addRecord('years', year);
            showToast('Academic year added successfully!');
            event.target.reset();
            closeModal('addYearModal');
            loadYears();
        }

        async function loadYears() {
            const years = await getAll('years');
            const container = document.getElementById('yearsContainer');
            container.innerHTML = '';
            if (years.length === 0) {
                container.innerHTML = '<p style="color: var(--color-gray);">No academic years configured yet.</p>';
                return;
            }
            years.forEach(year => {
                const div = document.createElement('div');
                div.className = 'summary-box';
                div.innerHTML = `<strong>Year ${year.year}:</strong> ${year.startDate} to ${year.endDate}<button class="btn btn-small btn-danger" style="float: right;" onclick="deleteYear(${year.id})">Delete</button>`;
                container.appendChild(div);
            });
            updateDashboard();
        }

        async function deleteYear(id) {
            showConfirm('Delete this academic year?', async function () {
                await deleteRecord('years', id);
                showToast('Academic year deleted', 'info');
                loadYears();
            });
        }

        async function addCustomSemester() {
            const year = document.getElementById('customYearInput').value;
            const semester = document.getElementById('customSemesterInput').value;
            if (!year || !semester) {
                showToast('Please fill all fields', 'error');
                return;
            }
            const record = {
                year: parseInt(year),
                semester: parseInt(semester),
                type: 'custom',
                createdAt: new Date().toISOString()
            };
            await addRecord('years', record);
            showToast('Semester added successfully!');
            document.getElementById('customYearInput').value = '';
            document.getElementById('customSemesterInput').value = '';
            loadYears();
        }

        // UPDATED: Download templates that match export format
        function downloadTemplate(type) {
            const templates = {
                students: `Roll No,First Name,Last Name,Email,Department,Year,Semester,Created Date\n22156148040,John,Doe,john@college.edu,Computer Science,3,5,2023-09-01\n22101148001,Alice,Smith,alice@college.edu,Computer Science,3,5,2023-09-01`,
                faculty: `Faculty ID,First Name,Last Name,Email,Department,Specialization,Created Date\nFAC001,Faculty,One,faculty1@college.edu,Computer Science,Data Structures,2023-09-01\nFAC002,Faculty,Two,faculty2@college.edu,Computer Science,Networks,2023-09-01`,
                classes: `Class Code,Course Name,Department,Semester,Faculty,Year,Credits,Created Date\nCS101,Data Structures,Computer Science,5,Faculty One,3,3,2023-09-01\nCS102,Programming,Computer Science,5,Faculty One,3,3,2023-09-01`
            };
            const csv = templates[type];
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${type}_import_template.csv`;
            a.click();
            showToast(`Downloaded ${type} import template`, 'info');
        }

        // UPDATED: Student import to match export format
        async function handleStudentUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            let text = await file.text();
            text = text.replace(/^\uFEFF/, ''); // Remove BOM

            const sections = text.split('--- Year ');
            const progress = document.getElementById('studentProgress');
            const progressBar = document.getElementById('studentProgressBar');
            progress.style.display = 'block';

            let imported = 0;
            let skipped = 0;
            let totalProcessed = 0;

            for (let section of sections) {
                if (!section.trim()) continue;

                const lines = section.split(/\r\n|\n|\r/);
                if (lines.length < 2) continue;

                // Skip the first line (Year header)
                let startIndex = 1;
                if (lines[0].includes('Students')) {
                    startIndex = 2; // Skip the header line too
                }

                for (let i = startIndex; i < lines.length; i++) {
                    if (lines[i].trim() === '' || lines[i].includes('--- Year')) continue;

                    totalProcessed++;

                    // Parse CSV line properly handling quotes
                    const values = [];
                    let inQuotes = false;
                    let currentValue = '';

                    for (let char of lines[i]) {
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(currentValue);
                            currentValue = '';
                        } else {
                            currentValue += char;
                        }
                    }
                    values.push(currentValue);

                    // Trim all values
                    const cleanedValues = values.map(v => v.trim());

                    // Expected columns: Roll No, First Name, Last Name, Email, Department, Year, Semester, Created Date
                    if (cleanedValues.length < 8) {
                        console.log('Skipping - insufficient columns:', cleanedValues);
                        skipped++;
                        continue;
                    }

                    try {
                        // Parse the data
                        const rollNo = cleanedValues[0];
                        const firstName = cleanedValues[1];
                        const lastName = cleanedValues[2];
                        const email = cleanedValues[3] || 'N/A';
                        const department = cleanedValues[4];
                        const year = parseInt(cleanedValues[5]) || 1;
                        const semester = parseInt(cleanedValues[6]) || 1;

                        // Parse the date - handle different formats
                        let createdDate = new Date().toISOString();
                        const dateStr = cleanedValues[7];
                        if (dateStr) {
                            // Try parsing "MM/DD/YYYY" format
                            const dateParts = dateStr.split('/');
                            if (dateParts.length === 3) {
                                const month = parseInt(dateParts[0]) - 1; // JS months are 0-indexed
                                const day = parseInt(dateParts[1]);
                                const year = parseInt(dateParts[2]);
                                const dateObj = new Date(year, month, day);
                                if (!isNaN(dateObj.getTime())) {
                                    createdDate = dateObj.toISOString();
                                }
                            }
                        }

                        // Basic validation
                        if (!rollNo || !firstName) {
                            console.log('Skipping - missing rollNo or firstName:', cleanedValues);
                            skipped++;
                            continue;
                        }

                        // Check if student already exists
                        const allStudents = await getAll('students');
                        const exists = allStudents.find(s => s.rollNo === rollNo);

                        if (exists) {
                            console.log('Skipping - already exists:', rollNo);
                            skipped++;
                            continue;
                        }

                        // Add the student
                        await addRecord('students', {
                            rollNo: rollNo,
                            firstName: firstName,
                            lastName: lastName || '',
                            email: email,
                            department: department,
                            year: year,
                            semester: semester,
                            createdAt: createdDate
                        });

                        imported++;

                    } catch (e) {
                        console.error('Error importing row:', e, cleanedValues);
                        skipped++;
                    }

                    // Update progress
                    const percent = Math.round((totalProcessed / 300) * 100); // Approximate total
                    progressBar.style.width = Math.min(percent, 100) + '%';
                    progressBar.textContent = Math.min(percent, 100) + '%';
                }
            }

            progress.style.display = 'none';

            if (imported > 0) {
                showToast(`Successfully imported ${imported} students! ${skipped > 0 ? `(${skipped} skipped)` : ''}`);
                loadStudents();
            } else {
                showToast(`No students imported. ${skipped} skipped. Check console for details.`, 'error');
            }

            event.target.value = '';
        }

        // UPDATED: Faculty import to match export format
        async function handleFacultyUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            let text = await file.text();
            text = text.replace(/^\uFEFF/, '');
            const lines = text.split(/\r\n|\n|\r/);
            const headers = lines[0].split(',').map(h => h.replace(/^"|"$/g, '').trim().toLowerCase().replace(/\s+/g, ''));

            const progress = document.getElementById('facultyProgress');
            const progressBar = document.getElementById('facultyProgressBar');
            progress.style.display = 'block';
            let imported = 0;
            let skipped = 0;

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                const values = lines[i].split(',').map(v => v.replace(/^"|"$/g, '').trim());
                if (values.length < 2) continue;

                const record = {};
                headers.forEach((header, idx) => {
                    if (idx < values.length) {
                        record[header] = values[idx];
                    }
                });

                // Map headers to our data structure
                const facultyId = record['facultyid'] || record['faculty_id'] || '';
                const firstName = record['firstname'] || record['first_name'] || '';
                const lastName = record['lastname'] || record['last_name'] || '';
                const email = record['email'] || '';
                const department = record['department'] || '';
                const specialization = record['specialization'] || '';
                const createdDate = record['createddate'] || record['created_date'] || new Date().toISOString();

                if (!facultyId || !firstName) {
                    skipped++;
                    continue;
                }

                try {
                    await addRecord('faculty', {
                        facultyId: facultyId,
                        password: 'pass123', // Default password for imported faculty
                        firstName: firstName,
                        lastName: lastName,
                        email: email,
                        department: department,
                        specialization: specialization,
                        createdAt: createdDate
                    });
                    imported++;
                } catch (e) {
                    console.error('Error importing row:', e);
                    skipped++;
                }

                const percent = Math.round((i / lines.length) * 100);
                progressBar.style.width = percent + '%';
                progressBar.textContent = percent + '%';
            }

            progress.style.display = 'none';
            showToast(`Imported ${imported} faculty members successfully! ${skipped > 0 ? `(${skipped} skipped)` : ''}`);
            loadFaculty();
            event.target.value = '';
        }

        // UPDATED: Classes import to match export format
        async function handleClassesUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            let text = await file.text();
            text = text.replace(/^\uFEFF/, ''); // Remove BOM

            const sections = text.split('--- Year ');
            const progress = document.getElementById('classesProgress');
            const progressBar = document.getElementById('classesProgressBar');
            progress.style.display = 'block';

            let imported = 0;
            let skipped = 0;
            let totalProcessed = 0;
            const allFaculty = await getAll('faculty');

            // Normalize department names
            const normalizeDepartment = (dept) => {
                if (!dept) return 'Computer Science';

                const lowerDept = dept.toLowerCase();
                if (lowerDept.includes('cyber')) return 'CSE(Cyber Security)';
                if (lowerDept.includes('network')) return 'CSE(Networks)';
                if (lowerDept.includes('computer science') || lowerDept.includes('cse')) return 'Computer Science';
                if (lowerDept.includes('civil')) return 'Civil';
                if (lowerDept.includes('mechanical')) return 'Mechanical';
                if (lowerDept.includes('electrical')) return 'Electrical';
                if (lowerDept.includes('ece') || lowerDept.includes('electronic')) return 'ECE';
                if (lowerDept.includes('applied') || lowerDept.includes('science')) return 'Applied Science';
                return 'Computer Science'; // Default
            };

            for (let section of sections) {
                if (!section.trim()) continue;

                const lines = section.split(/\r\n|\n|\r/);
                if (lines.length < 2) continue;

                // Skip the first line (Year header)
                let startIndex = 1;
                if (lines[0].includes('Classes')) {
                    startIndex = 2; // Skip the header line too
                }

                for (let i = startIndex; i < lines.length; i++) {
                    if (lines[i].trim() === '' || lines[i].includes('--- Year')) continue;

                    totalProcessed++;

                    // Parse CSV line properly handling quotes
                    const values = [];
                    let inQuotes = false;
                    let currentValue = '';

                    for (let char of lines[i]) {
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(currentValue);
                            currentValue = '';
                        } else {
                            currentValue += char;
                        }
                    }
                    values.push(currentValue);

                    // Trim all values
                    const cleanedValues = values.map(v => v.trim());

                    // Expected columns: Class Code, Course Name, Department, Semester, Faculty, Year, Credits, Created Date
                    if (cleanedValues.length < 8) {
                        console.log('Skipping class - insufficient columns:', cleanedValues);
                        skipped++;
                        continue;
                    }

                    try {
                        // Parse the data
                        const code = cleanedValues[0];
                        const name = cleanedValues[1];
                        const rawDepartment = cleanedValues[2];
                        const semester = parseInt(cleanedValues[3]) || 1;
                        const facultyName = cleanedValues[4];
                        const year = parseInt(cleanedValues[5]) || new Date().getFullYear();
                        const credits = parseInt(cleanedValues[6]) || 3;

                        // Normalize department
                        const department = normalizeDepartment(rawDepartment);

                        // Parse the date
                        let createdDate = new Date().toISOString();
                        const dateStr = cleanedValues[7];
                        if (dateStr) {
                            // Try parsing "MM/DD/YYYY" format
                            const dateParts = dateStr.split('/');
                            if (dateParts.length === 3) {
                                const month = parseInt(dateParts[0]) - 1;
                                const day = parseInt(dateParts[1]);
                                const year = parseInt(dateParts[2]);
                                const dateObj = new Date(year, month, day);
                                if (!isNaN(dateObj.getTime())) {
                                    createdDate = dateObj.toISOString();
                                }
                            }
                        }

                        // Basic validation
                        if (!code || !name) {
                            console.log('Skipping class - missing code or name:', cleanedValues);
                            skipped++;
                            continue;
                        }

                        // Check if faculty exists, create if not
                        let assignedFaculty = facultyName;
                        const facultyNameLower = facultyName.toLowerCase().trim();
                        const existingFaculty = allFaculty.find(f =>
                            `${f.firstName} ${f.lastName}`.toLowerCase() === facultyNameLower
                        );

                        if (!existingFaculty && facultyName && facultyName !== 'New Faculty') {
                            // Create new faculty with default credentials
                            const nameParts = facultyName.split(' ');
                            const firstName = nameParts[0] || 'Faculty';
                            const lastName = nameParts.slice(1).join(' ') || 'Member';

                            const newFaculty = {
                                facultyId: `FAC${Math.floor(Math.random() * 10000).toString().padStart(4, '0')}`,
                                firstName: firstName,
                                lastName: lastName,
                                email: `${firstName.toLowerCase()}.${lastName.toLowerCase()}@college.edu`,
                                department: department,
                                specialization: name,
                                password: 'pass123',
                                createdAt: new Date().toISOString()
                            };

                            await addRecord('faculty', newFaculty);
                            allFaculty.push(newFaculty);
                            console.log('Created new faculty:', facultyName);
                        } else if (facultyName === 'New Faculty') {
                            assignedFaculty = ''; // Leave empty for admin to assign later
                        }

                        // Check if class already exists
                        const allClasses = await getAll('classes');
                        const exists = allClasses.find(c => c.code === code && c.year === year);

                        if (exists) {
                            console.log('Skipping class - already exists:', code);
                            skipped++;
                            continue;
                        }

                        // Add the class
                        await addRecord('classes', {
                            code: code,
                            name: name,
                            department: department,
                            semester: semester,
                            faculty: assignedFaculty,
                            year: year,
                            credits: credits,
                            createdAt: createdDate
                        });

                        imported++;

                    } catch (e) {
                        console.error('Error importing class row:', e, cleanedValues);
                        skipped++;
                    }

                    // Update progress
                    const percent = Math.round((totalProcessed / 30) * 100); // Approximate total
                    progressBar.style.width = Math.min(percent, 100) + '%';
                    progressBar.textContent = Math.min(percent, 100) + '%';
                }
            }

            progress.style.display = 'none';

            if (imported > 0) {
                showToast(`Successfully imported ${imported} classes! ${skipped > 0 ? `(${skipped} skipped)` : ''}`);
                loadClasses();
                loadFaculty(); // Refresh faculty list
            } else {
                showToast(`No classes imported. ${skipped} skipped. Check console for details.`, 'error');
            }

            event.target.value = '';
        }

        function toggleStatus(element) {
            const statuses = ['absent', 'present', 'late'];
            const current = element.dataset.status;
            const currentIndex = statuses.indexOf(current);
            const nextStatus = statuses[(currentIndex + 1) % statuses.length];
            element.dataset.status = nextStatus;
            element.style.borderColor = nextStatus === 'present' ? 'green' : nextStatus === 'absent' ? 'red' : 'orange';
            element.style.background = nextStatus === 'present' ? 'rgba(39,174,96,0.2)' : nextStatus === 'absent' ? 'rgba(231,76,60,0.2)' : 'rgba(243,156,18,0.2)';
        }

        function resetAttendance() {
            document.querySelectorAll('#studentGrid > div').forEach(el => {
                el.dataset.status = 'absent';
                el.style.borderColor = 'transparent';
                el.style.background = 'var(--color-light)';
            });
        }

        async function updateDashboard() {
            const students = await getAll('students');
            const faculty = await getAll('faculty');
            const classes = await getAll('classes');
            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('totalFaculty').textContent = faculty.length;
            document.getElementById('totalClasses').textContent = classes.length;
            const activeYearsSet = new Set();
            students.forEach(student => {
                if (student.semester) {
                    const year = Math.ceil(student.semester / 2);
                    activeYearsSet.add(year);
                }
            });
            document.getElementById('activeYears').textContent = activeYearsSet.size;
        }

        async function saveSettings(event) {
            event.preventDefault();
            showToast('Settings saved!');
        }

        async function exportAllData() {
            const data = {
                students: await getAll('students'),
                faculty: await getAll('faculty'),
                classes: await getAll('classes'),
                years: await getAll('years'),
                exportDate: new Date().toISOString()
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `attendance_backup_${new Date().getTime()}.json`;
            a.click();
        }

        document.getElementById('attendanceDate').valueAsDate = new Date();

        (async () => {
            await initDB();
            await loadStudents();
            await loadFaculty();
            await loadClasses();
            await loadYears();
            await updateDashboard();
        })();
    </script>
</body>

</html>
